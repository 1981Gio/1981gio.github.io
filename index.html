<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>GiOrders Pro</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0A84FF">

<style>
body{
font-family:-apple-system;
margin:0;
background:#f2f2f7;
transition:0.3s;
}

.dark{
background:#1c1c1e;
color:white;
}

.card{
background:white;
margin:15px;
padding:15px;
border-radius:15px;
box-shadow:0 4px 10px rgba(0,0,0,0.1);
transition:0.3s;
}

.dark .card{
background:#2c2c2e;
}

button{
padding:8px 12px;
border:none;
border-radius:8px;
cursor:pointer;
}

.primary{background:#0A84FF;color:white;}
.red{background:#ff3b30;color:white;}
.green{background:#34c759;color:white;}
.gray{background:#d1d1d6;}

select,input{
padding:6px;
border-radius:6px;
border:1px solid #ccc;
}

.row{
margin-bottom:14px;
padding:12px;
border-radius:12px;
background:#f9f9fb;
transition:0.3s;
}

.dark .row{
background:#3a3a3c;
}

.editing{
background:#fff3cd !important;
}

.orderTop{
font-weight:bold;
font-size:16px;
margin-bottom:5px;
}

.orderBottom{
display:flex;
justify-content:space-between;
font-size:14px;
}

.sizeRow{
display:flex;
justify-content:space-between;
margin-bottom:8px;
}

.sizeRow select{
width:45%;
}

.pinPad button{
font-size:20px;
padding:15px;
}

</style>
</head>
<body>

<div id="login"></div>
<div id="app" style="display:none;"></div>

<script>

let savedPIN=localStorage.getItem("pin")||"1926";
let eventi=JSON.parse(localStorage.getItem("eventi")||"{}");
let eventoCorrente=null;
let indiceModifica=null;

let taglie=["XS","S","M","L","XL","XXL"];

function salva(){
localStorage.setItem("eventi",JSON.stringify(eventi));
}

function renderLogin(){
login.innerHTML=`
<div class="card" style="text-align:center;">
<h3>GiOrders Pro</h3>
<div id="dots" style="font-size:28px;letter-spacing:8px;margin:20px;">‚óã ‚óã ‚óã ‚óã</div>
<div class="pinPad" style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;">
${[1,2,3,4,5,6,7,8,9].map(n=>`<button onclick="digit(${n})">${n}</button>`).join("")}
<button onclick="del()">‚å´</button>
<button onclick="digit(0)">0</button>
<button onclick="clearPin()">C</button>
</div>
</div>`;
}

let pinInput="";
function digit(n){
if(pinInput.length>=4)return;
pinInput+=n;
updateDots();
if(pinInput.length===4)setTimeout(checkPin,200);
}

function del(){
pinInput=pinInput.slice(0,-1);
updateDots();
}

function clearPin(){
pinInput="";
updateDots();
}

function updateDots(){
let s="";
for(let i=0;i<4;i++){
s+=i<pinInput.length?"‚óè ":"‚óã ";
}
dots.innerHTML=s;
}

function checkPin(){
if(pinInput===savedPIN){
login.style.display="none";
app.style.display="block";
renderHome();
}else{
alert("PIN errato");
pinInput="";
updateDots();
}
}

function renderHome(){
app.innerHTML=`
<div class="card">
<h3>Nuovo Evento</h3>
<input id="nomeEvento" placeholder="Nome evento"><br><br>
<select id="tipoEvento">
<option value="abbigliamento">Abbigliamento</option>
<option value="gadget">Gadget</option>
<option value="bus">Bus</option>
</select><br><br>
<input id="prezzoEvento" type="number" placeholder="Prezzo unitario"><br><br>
<button class="primary" onclick="creaEvento()">Crea Evento</button>
<button onclick="toggleDark()">üåô</button>
</div>

${Object.keys(eventi).map(e=>`
<div class="card">
<b>${e}</b><br>
<button onclick="entraEvento('${e}')">Apri</button>
<button class="red" onclick="eliminaEvento('${e}')">Elimina</button>
</div>
`).join("")}
`;
}

function creaEvento(){
let nome=nomeEvento.value;
let tipo=tipoEvento.value;
let prezzo=parseFloat(prezzoEvento.value||0);
if(!nome)return;
eventi[nome]={tipo,prezzo,ordini:[]};
salva();
renderHome();
}

function eliminaEvento(n){
if(confirm("Eliminare evento?")){
delete eventi[n];
salva();
renderHome();
}
}

function entraEvento(n){
eventoCorrente=n;
renderEvento();
}

function renderEvento(){
let ev=eventi[eventoCorrente];

app.innerHTML=`
<div class="card">
<h3>${eventoCorrente}</h3>
Prezzo ‚Ç¨ ${ev.prezzo}<br><br>
<input id="cliente" placeholder="Nome cliente"><br><br>

<div id="formArea"></div>

<button class="primary" id="btnSubmit" onclick="aggiungiOrdine()">Aggiungi</button>
<button class="gray" id="btnCancel" style="display:none;" onclick="resetForm()">Annulla modifica</button>
<button onclick="renderHome()">Indietro</button>
</div>

<div class="card">
<h3>Ordini</h3>
<div id="listaOrdini"></div>
</div>

<div class="card">
<h3>Statistiche</h3>
<div id="stats"></div>
</div>
`;

renderForm();
aggiornaEvento();
}

function renderForm(){
let ev=eventi[eventoCorrente];
let html="";
if(ev.tipo==="abbigliamento"){
taglie.forEach(t=>{
html+=`
<div class="sizeRow">
<label>${t}</label>
<select id="q_${t}">
${[0,1,2,3,4,5,6,7,8,9,10].map(n=>`<option>${n}</option>`)}
</select>
</div>`;
});
}else{
html=`
<select id="q_obj">
${[0,1,2,3,4,5,6,7,8,9,10].map(n=>`<option>${n}</option>`)}
</select>`;
}
formArea.innerHTML=html;
}

function aggiungiOrdine(){
let ev=eventi[eventoCorrente];
let nome=cliente.value;
if(!nome)return;

let dettagli={},tot=0;

if(ev.tipo==="abbigliamento"){
taglie.forEach(t=>{
let q=parseInt(document.getElementById("q_"+t)?.value||0);
if(q>0){dettagli[t]=q;tot+=q*ev.prezzo;}
});
}else{
let q=parseInt(document.getElementById("q_obj").value);
if(q>0){dettagli["pezzi"]=q;tot+=q*ev.prezzo;}
}

if(indiceModifica!==null){
ev.ordini[indiceModifica]={nome,dettagli,tot,pagato:ev.ordini[indiceModifica].pagato};
indiceModifica=null;
}else{
ev.ordini.push({nome,dettagli,tot,pagato:false});
}

salva();
resetForm();
aggiornaEvento();
}

function resetForm(){
cliente.value="";
renderForm();
btnSubmit.innerText="Aggiungi";
btnCancel.style.display="none";
indiceModifica=null;
document.querySelectorAll(".row").forEach(r=>r.classList.remove("editing"));
}

function aggiornaEvento(){
let ev=eventi[eventoCorrente];

listaOrdini.innerHTML=ev.ordini.map((o,i)=>`
<div class="row ${indiceModifica===i?"editing":""}">
<div class="orderTop">${o.nome}</div>
<div class="orderBottom">
<div>${Object.entries(o.dettagli).map(([k,v])=>`${v} ${k}`).join(" ")}</div>
<div>‚Ç¨ ${o.tot} <br> 
<span style="color:${o.pagato?"#34c759":"#ff3b30"};">
${o.pagato?"PAGATO":"NON PAGATO"}
</span>
</div>
</div>
<button onclick="modificaOrdine(${i})">‚úèÔ∏è</button>
<button class="red" onclick="eliminaOrdine(${i})">üóë</button>
<button class="${o.pagato?"green":"gray"}" onclick="togglePagato(${i})">
${o.pagato?"‚úî":"Paga"}
</button>
</div>
`).join("");

let totInc=0,totNon=0;
ev.ordini.forEach(o=>{
if(o.pagato)totInc+=o.tot;
else totNon+=o.tot;
});
stats.innerHTML=`
Incassato ‚Ç¨ ${totInc}<br>
Da incassare ‚Ç¨ ${totNon}
`;
}

function modificaOrdine(i){
indiceModifica=i;
let o=eventi[eventoCorrente].ordini[i];
cliente.value=o.nome;
renderForm();

for(let k in o.dettagli){
let el=document.getElementById("q_"+k)||document.getElementById("q_obj");
if(el)el.value=o.dettagli[k];
}

btnSubmit.innerText="Salva Modifica";
btnCancel.style.display="inline-block";

document.querySelectorAll(".row").forEach(r=>r.classList.remove("editing"));
document.querySelectorAll(".row")[i].classList.add("editing");

window.scrollTo({top:0,behavior:"smooth"});
}

function eliminaOrdine(i){
eventi[eventoCorrente].ordini.splice(i,1);
salva();
aggiornaEvento();
}

function togglePagato(i){
let o=eventi[eventoCorrente].ordini[i];
o.pagato=!o.pagato;
salva();
aggiornaEvento();
}

function toggleDark(){
document.body.classList.toggle("dark");
}

renderLogin();

</script>
</body>
</html>
