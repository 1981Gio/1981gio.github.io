<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GiOrders Pro</title>

<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="1FFB8DDC-1EC1-4569-971E-598213CC5587.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<style>
body{font-family:-apple-system;margin:0;background:#f2f2f7}
.dark{background:#111;color:white}
.card{background:white;margin:15px;padding:16px;border-radius:16px;box-shadow:0 4px 12px rgba(0,0,0,.06)}
.dark .card{background:#1c1c1e}
button{padding:6px 10px;border:none;border-radius:8px;font-size:13px;cursor:pointer}
.primary{background:#0A84FF;color:white}
.red{background:#ff3b30;color:white}
.green{background:#34c759;color:white}
.gray{background:#d1d1d6}
input,select{padding:6px;border-radius:8px;border:1px solid #ccc;font-size:14px}
.sizeRow{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
.orderBox{padding:10px 0;border-bottom:1px solid #e5e5ea}
.orderTop{display:flex;justify-content:space-between;font-weight:600;font-size:15px}
.orderBottom{display:flex;justify-content:space-between;font-size:14px;margin-top:3px}
.statusPaid{color:#34c759;font-weight:600}
.statusUnpaid{color:#ff3b30;font-weight:600}
.actions{margin-top:6px}
.actions button{margin-right:6px}
.highlight{background:#fff3cd;border-radius:10px;padding:6px}
.pin-screen{position:fixed;inset:0;background:#0A84FF;color:white;display:flex;flex-direction:column;justify-content:center;align-items:center}
.keypad{display:grid;grid-template-columns:repeat(3,70px);gap:10px}
.keypad button{font-size:20px;padding:15px;background:#004aad;color:white}
.hidden{display:none}
@media print{button{display:none}body{background:white}}
</style>
</head>

<body>

<div id="pinScreen" class="pin-screen">
<h2>Inserisci PIN</h2>
<div id="pinDisplay" style="font-size:32px;letter-spacing:10px;margin:20px">----</div>
<div class="keypad">
<button onclick="press(1)">1</button>
<button onclick="press(2)">2</button>
<button onclick="press(3)">3</button>
<button onclick="press(4)">4</button>
<button onclick="press(5)">5</button>
<button onclick="press(6)">6</button>
<button onclick="press(7)">7</button>
<button onclick="press(8)">8</button>
<button onclick="press(9)">9</button>
<button onclick="clearPin()">C</button>
<button onclick="press(0)">0</button>
<button onclick="checkPin()">OK</button>
</div>
</div>

<div id="app" class="hidden"></div>

<script>

let data = JSON.parse(localStorage.getItem("gioData") || JSON.stringify({
  settings:{pin:"1926",dark:false},
  events:[]
}));

let currentEvent=null;
let editIndex=null;
let pinInput="";

function save(){localStorage.setItem("gioData",JSON.stringify(data));}

function press(n){if(pinInput.length<4){pinInput+=n;updatePin();}}
function clearPin(){pinInput="";updatePin();}
function updatePin(){document.getElementById("pinDisplay").innerText=pinInput.padEnd(4,"-");}
function checkPin(){
 if(pinInput===data.settings.pin){
  document.getElementById("pinScreen").classList.add("hidden");
  document.getElementById("app").classList.remove("hidden");
  renderHome();
 } else alert("PIN errato");
}

function renderHome(){
document.getElementById("app").innerHTML=`
<div class="card">
<h2>Eventi</h2>
<input id="evName" placeholder="Nome evento"><br>
<select id="evType">
<option>Abbigliamento</option>
<option>Gadget</option>
<option>Bus</option>
</select><br>
<input id="evPrice" type="number" placeholder="Prezzo ‚Ç¨"><br>
<input id="evSeats" type="number" placeholder="Posti Bus (solo Bus)"><br>
<button class="primary" onclick="addEvent()">Crea</button>
<button onclick="toggleDark()">üåô</button>
<button onclick="exportData()">Backup</button>
<input type="file" onchange="importData(event)">
</div>
${data.events.map((e,i)=>`
<div class="card">
<b>${e.name}</b>
<button onclick="openEvent(${i})">Apri</button>
<button class="red" onclick="delEvent(${i})">Elimina</button>
</div>`).join("")}
`;
if(data.settings.dark)document.body.classList.add("dark");
}

function toggleDark(){data.settings.dark=!data.settings.dark;save();renderHome();}

function addEvent(){
let name=evName.value;
if(!name)return;
data.events.push({
 name,
 type:evType.value,
 price:parseFloat(evPrice.value||0),
 seats:parseInt(evSeats.value||0),
 orders:[]
});
save();renderHome();
}

function delEvent(i){if(confirm("Eliminare?")){data.events.splice(i,1);save();renderHome();}}

function openEvent(i){
currentEvent=i;
let ev=data.events[i];
document.getElementById("app").innerHTML=`
<div class="card">
<h2>${ev.name} - ‚Ç¨${ev.price}</h2>
<input id="custName" placeholder="Nome"><br>
<div id="quantArea"></div>
<label>Pagato</label> <input type="checkbox" id="paid"><br>
<button class="primary" onclick="saveOrder()">Salva</button>
<button onclick="cancelEdit()">Annulla</button>
<button onclick="renderHome()">Indietro</button>
<button onclick="window.print()">Stampa</button>
</div>
<div class="card"><h3>Ordini</h3><div id="orders"></div></div>
<div class="card"><h3>Riepilogo</h3><div id="summary"></div></div>
`;
renderQuantArea();
renderOrders();
}

function renderQuantArea(){
let ev=data.events[currentEvent];
let html="";
if(ev.type==="Abbigliamento"){
["XS","S","M","L","XL","XXL"].forEach(s=>{
 html+=`
 <div class="sizeRow">
  <div>${s}</div>
  <select id="q_${s}">
  ${[...Array(11).keys()].map(n=>`<option>${n}</option>`).join("")}
  </select>
 </div>`;
});
}else{
 html+=`
 <div class="sizeRow">
  <div>Quantit√†</div>
  <select id="q_Q">
  ${[...Array(51).keys()].map(n=>`<option>${n}</option>`).join("")}
  </select>
 </div>`;
}
document.getElementById("quantArea").innerHTML=html;
}

function saveOrder(){
let ev=data.events[currentEvent];
let name=custName.value;if(!name)return;
let sizes={};let totalQty=0;
if(ev.type==="Abbigliamento"){
["XS","S","M","L","XL","XXL"].forEach(s=>{
 let q=parseInt(document.getElementById("q_"+s).value);
 if(q>0){sizes[s]=q;totalQty+=q;}
});
}else{
 let q=parseInt(document.getElementById("q_Q").value);
 if(q>0){sizes["Q"]=q;totalQty+=q;}
}
if(ev.type==="Bus"){
 let booked=ev.orders.reduce((a,b)=>a+Object.values(b.sizes).reduce((x,y)=>x+y,0),0);
 if(booked+totalQty>ev.seats){alert("Posti insufficienti");return;}
}
let order={name,sizes,total:totalQty*ev.price,paid:paid.checked};
if(editIndex!=null){ev.orders[editIndex]=order;editIndex=null;}
else ev.orders.push(order);
save();renderOrders();custName.value="";renderQuantArea();
}

function renderOrders(){
let ev=data.events[currentEvent];
let container=document.getElementById("orders");
container.innerHTML="";
ev.orders.forEach((o,i)=>{
container.innerHTML+=`
<div class="orderBox ${editIndex===i?'highlight':''}">
<div class="orderTop">
 <div>${o.name}</div>
 <div>‚Ç¨ ${o.total}</div>
</div>
<div class="orderBottom">
 <div>${formatSizes(o)}</div>
 <div class="${o.paid?'statusPaid':'statusUnpaid'}">${o.paid?'PAGATO':'NON PAGATO'}</div>
</div>
<div class="actions">
 <button onclick="editOrder(${i})">‚úèÔ∏è</button>
 <button class="red" onclick="deleteOrder(${i})">üóë</button>
 <button onclick="togglePaid(${i})">üîÑ</button>
</div>
</div>`;
});
renderSummary();
}

function editOrder(i){
editIndex=i;
let o=data.events[currentEvent].orders[i];
custName.value=o.name;paid.checked=o.paid;
renderQuantArea();
for(let s in o.sizes){
 let el=document.getElementById("q_"+s);
 if(el)el.value=o.sizes[s];
}
window.scrollTo({top:0,behavior:'smooth'});
}

function deleteOrder(i){
data.events[currentEvent].orders.splice(i,1);
save();renderOrders();
}

function togglePaid(i){
data.events[currentEvent].orders[i].paid=!data.events[currentEvent].orders[i].paid;
save();renderOrders();
}

function renderSummary(){
let ev=data.events[currentEvent];
let sum=document.getElementById("summary");
let sorted=[...ev.orders].sort((a,b)=>a.name.localeCompare(b.name));
sum.innerHTML="";
sorted.forEach(o=>{
sum.innerHTML+=`
<div class="orderBox">
<div class="orderTop">
 <div>${o.name}</div>
 <div>‚Ç¨ ${o.total}</div>
</div>
<div class="orderBottom">
 <div>${formatSizes(o)}</div>
 <div class="${o.paid?'statusPaid':'statusUnpaid'}">${o.paid?'PAGATO':'NON PAGATO'}</div>
</div>
</div>`;
});
}

function formatSizes(o){
return Object.entries(o.sizes).map(([k,v])=>`${v} ${k}`).join(" - ");
}

function cancelEdit(){editIndex=null;custName.value="";renderQuantArea();}

function exportData(){
let blob=new Blob([JSON.stringify(data)],{type:"application/json"});
let a=document.createElement("a");
a.href=URL.createObjectURL(blob);
a.download="giorders_backup.json";
a.click();
}

function importData(e){
let reader=new FileReader();
reader.onload=function(){data=JSON.parse(reader.result);save();renderHome();};
reader.readAsText(e.target.files[0]);
}

</script>
</body>
</html>
