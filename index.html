<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GiOrders Pro</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0A84FF">
<meta name="apple-mobile-web-app-capable" content="yes">
<link rel="apple-touch-icon" href="1FFB8DDC-1EC1-4569-971E-598213CC5587.png">

<style>
:root{--bg:#f2f2f7;--card:#fff;--text:#000;}
.dark{--bg:#1c1c1e;--card:#2c2c2e;--text:#fff;}

body{font-family:-apple-system,sans-serif;background:var(--bg);
color:var(--text);padding:16px;}

.card{
background:var(--card);
padding:16px;
border-radius:16px;
margin-bottom:16px;
box-shadow:0 6px 18px rgba(0,0,0,0.08);
}

button{
padding:10px;
border:none;
border-radius:12px;
font-size:14px;
margin-top:6px;
}

.primary{background:#0A84FF;color:white;}
.red{background:#ff3b30;color:white;}

input,select{
width:100%;
padding:8px;
margin-bottom:8px;
border-radius:10px;
border:1px solid #ccc;
}

.row{
display:flex;
gap:8px;
align-items:center;
margin-bottom:14px;
padding-bottom:8px;
border-bottom:1px solid #e5e5ea;
}

.switch{position:relative;width:44px;height:24px;}
.switch input{display:none;}
.slider{
position:absolute;top:0;left:0;right:0;bottom:0;
background:#ccc;border-radius:24px;
}
.slider:before{
content:"";position:absolute;
height:18px;width:18px;
left:3px;bottom:3px;
background:white;border-radius:50%;
transition:.3s;
}
input:checked + .slider{background:#34c759;}
input:checked + .slider:before{transform:translateX(20px);}

.stat-box{
background:#e9f1ff;
padding:10px;
border-radius:10px;
margin-bottom:6px;
}

.summary-box{
background:#f4f4f6;
padding:10px;
border-radius:10px;
margin-bottom:6px;
}

.pin-grid{
display:grid;
grid-template-columns:repeat(3,1fr);
gap:10px;
margin-top:15px;
}

.pin-grid button{
font-size:20px;
padding:18px;
}

@media print{
button,.switch{display:none;}
body{background:white;}
}
</style>
</head>

<body>

<div id="login"></div>
<div id="app" style="display:none;"></div>

<script>

/* ================= PIN ================= */

let savedPIN = localStorage.getItem("gi_pin") || "1926";
let pinValue="";

function renderLogin(){
login.innerHTML=`
<div class="card" style="text-align:center;">
<h2>GiOrders Pro</h2>

<div id="dots" style="font-size:28px;letter-spacing:10px;margin:20px 0;">
‚óã ‚óã ‚óã ‚óã
</div>

<div class="pin-grid">
${[1,2,3,4,5,6,7,8,9].map(n=>`
<button onclick="digita(${n})">${n}</button>
`).join("")}
<button onclick="cancella()">‚å´</button>
<button onclick="digita(0)">0</button>
<button onclick="resetPin()">Reset</button>
</div>
</div>`;
}

function digita(n){
if(pinValue.length>=4)return;
pinValue+=n;
aggiornaDots();
if(pinValue.length===4){
setTimeout(controllaPIN,200);
}
}

function cancella(){
pinValue=pinValue.slice(0,-1);
aggiornaDots();
}

function resetPin(){
pinValue="";
aggiornaDots();
}

function aggiornaDots(){
let out="";
for(let i=0;i<4;i++){
out+= i<pinValue.length ? "‚óè " : "‚óã ";
}
document.getElementById("dots").innerHTML=out;
}

function controllaPIN(){
if(pinValue===savedPIN){
login.style.display="none";
app.style.display="block";
renderHome();
}else{
alert("PIN errato");
pinValue="";
aggiornaDots();
}
}

function cambiaPIN(){
let nuovo=prompt("Nuovo PIN (4 cifre)");
if(nuovo && nuovo.length>=4){
savedPIN=nuovo;
localStorage.setItem("gi_pin",nuovo);
alert("PIN aggiornato");
}
}

/* ================= CORE ================= */

let eventi=JSON.parse(localStorage.getItem("gi_eventi"))||{};
let eventoCorrente=null;
let taglie=["XS","S","M","L","XL","XXL"];

function salva(){
localStorage.setItem("gi_eventi",JSON.stringify(eventi));
}

/* ================= HOME ================= */

function renderHome(){

let html=`
<div class="card">
<button onclick="toggleDark()">üåô Modalit√†</button>
<button onclick="cambiaPIN()">üîê Cambia PIN</button>
<button onclick="esportaBackup()">üíæ Backup</button>
<button onclick="importaBackup()">üì• Importa</button>
<input type="file" id="fileImport" style="display:none" onchange="leggiBackup(event)">
<h3>Crea Evento</h3>
<input id="nomeEvento" placeholder="Nome Evento">
<select id="tipoEvento">
<option value="maglia">Abbigliamento</option>
<option value="oggetto">Gadget</option>
</select>
<input type="number" id="prezzoEvento" placeholder="Prezzo fisso ‚Ç¨">
<button class="primary" onclick="creaEvento()">Crea</button>
</div>

<div class="card"><h3>Eventi</h3>
`;

for(let nome in eventi){
html+=`
<div class="row">
<button style="flex:1" onclick="apriEvento('${nome}')">${nome}</button>
<button class="red" onclick="eliminaEvento('${nome}')">X</button>
</div>`;
}

html+=`</div>`;
app.innerHTML=html;
}

function creaEvento(){
let nome=nomeEvento.value;
let tipo=tipoEvento.value;
let prezzo=parseFloat(prezzoEvento.value);
if(!nome||!prezzo)return;
eventi[nome]={tipo,prezzo,ordini:[]};
salva();
renderHome();
}

function eliminaEvento(nome){
if(confirm("Eliminare evento?")){
delete eventi[nome];
salva();
renderHome();
}
}

function apriEvento(nome){
eventoCorrente=nome;
renderEvento();
}

/* ================= EVENTO ================= */

function renderEvento(){

let ev=eventi[eventoCorrente];

let html=`
<div class="card">
<button onclick="renderHome()">‚Üê Torna</button>
<h3>${eventoCorrente}</h3>
<p><strong>Prezzo:</strong> ‚Ç¨ ${ev.prezzo}</p>
</div>

<div class="card">
<input id="cliente" placeholder="Nome Cliente">
`;

if(ev.tipo==="maglia"){
taglie.forEach(t=>{
html+=`
<div class="row">
<div style="flex:1">${t}</div>
<select id="q_${t}" style="flex:1">
<option value="0">0</option>
${[1,2,3,4,5,6,7,8,9].map(n=>`<option>${n}</option>`).join("")}
</select>
</div>`;
});
}else{
html+=`
<select id="q_obj">
<option value="0">Quantit√†</option>
${[1,2,3,4,5,6,7,8,9].map(n=>`<option>${n}</option>`).join("")}
</select>`;
}

html+=`
<button class="primary" onclick="aggiungiOrdine()">Aggiungi</button>
</div>

<div class="card"><h3>Ordini</h3><div id="listaOrdini"></div></div>
<div class="card"><h3>Statistiche</h3><div id="stats"></div></div>
<div class="card"><h3>üìã Riepilogo Ordini (A-Z)</h3><div id="riepilogoAlfabetico"></div></div>
<button onclick="window.print()">üñ® Stampa</button>
`;

app.innerHTML=html;
aggiornaEvento();
}

function aggiungiOrdine(){
let ev=eventi[eventoCorrente];
let nome=cliente.value;
if(!nome)return;

let dettagli={},totale=0;

if(ev.tipo==="maglia"){
taglie.forEach(t=>{
let q=parseInt(document.getElementById("q_"+t).value);
if(q>0){
dettagli[t]=q;
totale+=q*ev.prezzo;
document.getElementById("q_"+t).value="0";
}
});
}else{
let q=parseInt(q_obj.value);
if(q>0){
dettagli["pezzi"]=q;
totale+=q*ev.prezzo;
q_obj.value="0";
}
}

cliente.value="";
ev.ordini.push({nome,dettagli,totale,pagato:false});
salva();
aggiornaEvento();
}

function aggiornaEvento(){

let ev=eventi[eventoCorrente];
let lista=document.getElementById("listaOrdini");
let stats=document.getElementById("stats");
let riepilogo=document.getElementById("riepilogoAlfabetico");

lista.innerHTML="";
riepilogo.innerHTML="";

let inc=0,nonInc=0,totPezzi=0;
let riepilogoTaglie={};

ev.ordini.forEach((o,i)=>{

if(o.pagato)inc+=o.totale;else nonInc+=o.totale;

let dettagliTesto="";
for(let k in o.dettagli){
totPezzi+=o.dettagli[k];
dettagliTesto+=o.dettagli[k]+" "+k+" ";
if(ev.tipo==="maglia")
riepilogoTaglie[k]=(riepilogoTaglie[k]||0)+o.dettagli[k];
}

lista.innerHTML+=`
<div class="row">
<div style="flex:1">
<strong>${o.nome}</strong><br>
<small>${dettagliTesto} - ‚Ç¨ ${o.totale}</small>
</div>
<button onclick="modificaOrdine(${i})">‚úèÔ∏è</button>
<button class="red" onclick="eliminaOrdine(${i})">üóë</button>
<label class="switch">
<input type="checkbox" ${o.pagato?'checked':''}
onchange="togglePagato(${i})">
<span class="slider"></span>
</label>
</div>`;
});

/* STAT */

let media = ev.ordini.length? (inc+nonInc)/ev.ordini.length:0;
let percentPagato = (inc+nonInc)? ((inc/(inc+nonInc))*100).toFixed(1):0;

let statHTML=`
<div class="stat-box">Totale pezzi: ${totPezzi}</div>
<div class="stat-box">Ordini: ${ev.ordini.length}</div>
<div class="stat-box">Incassato: ‚Ç¨ ${inc}</div>
<div class="stat-box">Da incassare: ‚Ç¨ ${nonInc}</div>
<div class="stat-box">Media ‚Ç¨ per cliente: ‚Ç¨ ${media.toFixed(2)}</div>
<div class="stat-box">Percentuale pagato: ${percentPagato}%</div>
`;

for(let t in riepilogoTaglie){
statHTML+=`<div class="stat-box">Totale ${t}: ${riepilogoTaglie[t]}</div>`;
}

stats.innerHTML=statHTML;

/* RIEPILOGO A-Z */

let ordinati=[...ev.ordini].sort((a,b)=>a.nome.localeCompare(b.nome));
ordinati.forEach(o=>{
let dettagliTesto="";
for(let k in o.dettagli){
dettagliTesto+=o.dettagli[k]+" "+k+" ";
}
riepilogo.innerHTML+=`
<div class="summary-box">
<strong>${o.nome}</strong><br>
${dettagliTesto}<br>
‚Ç¨ ${o.totale} - ${o.pagato?"PAGATO":"NON PAGATO"}
</div>`;
});
}

function togglePagato(i){
eventi[eventoCorrente].ordini[i].pagato=
!eventi[eventoCorrente].ordini[i].pagato;
salva();
aggiornaEvento();
}

function eliminaOrdine(i){
if(confirm("Eliminare ordine?")){
eventi[eventoCorrente].ordini.splice(i,1);
salva();
aggiornaEvento();
}
}

function modificaOrdine(i){
let ordine=eventi[eventoCorrente].ordini[i];
let nuovoNome=prompt("Modifica nome:",ordine.nome);
if(nuovoNome) ordine.nome=nuovoNome;
salva();
aggiornaEvento();
}

/* BACKUP */

function esportaBackup(){
let dati={eventi:eventi,pin:savedPIN};
let blob=new Blob([JSON.stringify(dati)],{type:"application/json"});
let url=URL.createObjectURL(blob);
let a=document.createElement("a");
a.href=url;
a.download="giorders_backup.json";
a.click();
}

function importaBackup(){
document.getElementById("fileImport").click();
}

function leggiBackup(event){
let reader=new FileReader();
reader.onload=function(e){
let dati=JSON.parse(e.target.result);
eventi=dati.eventi||{};
savedPIN=dati.pin||"1926";
localStorage.setItem("gi_eventi",JSON.stringify(eventi));
localStorage.setItem("gi_pin",savedPIN);
alert("Backup ripristinato");
renderHome();
};
reader.readAsText(event.target.files[0]);
}

function toggleDark(){
document.body.classList.toggle("dark");
}

if ('serviceWorker' in navigator) {
navigator.serviceWorker.register('sw.js');
}

renderLogin();

</script>
</body>
</html>
