<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GiOrders Pro</title>

<link rel="manifest" href="manifest.json">

<style>
body{
font-family:-apple-system;
margin:0;
background:#f2f2f7;
transition:.3s;
}

.dark{
background:#1c1c1e;
color:white;
}

.card{
background:white;
margin:20px;
padding:20px;
border-radius:18px;
box-shadow:0 4px 12px rgba(0,0,0,.08);
}

.dark .card{
background:#2c2c2e;
}

h2{margin-top:0}

input,select{
width:100%;
padding:10px;
border-radius:10px;
border:1px solid #ccc;
margin-bottom:12px;
font-size:15px;
}

button{
padding:10px 14px;
border-radius:12px;
border:none;
font-size:14px;
}

.primary{background:#007aff;color:white}
.red{background:#ff3b30;color:white}
.green{color:#34c759;font-weight:600}
.gray{background:#e5e5ea}
.dark .gray{background:#3a3a3c;color:white}

.order-row{
display:flex;
justify-content:space-between;
align-items:center;
margin-bottom:12px;
padding:12px;
border-radius:12px;
background:#f9f9f9;
transition:.3s;
}

.dark .order-row{
background:#3a3a3c;
}

.highlight{
background:#fff3cd !important;
}

.keyboard{
display:grid;
grid-template-columns:repeat(3,1fr);
gap:10px;
margin-top:20px;
}

.keyboard button{
padding:18px;
font-size:18px;
}

.center{text-align:center}

</style>
</head>
<body>

<div id="app"></div>

<script>
let data = JSON.parse(localStorage.getItem("giorders_pro")) || {
pin:"1926",
dark:false,
events:[]
};

let currentEvent=null;
let editIndex=null;

/* ---------- SAVE ---------- */
function save(){
localStorage.setItem("giorders_pro",JSON.stringify(data));
}

/* ---------- PIN SCREEN ---------- */
function renderPin(){

document.getElementById("app").innerHTML=`
<div class="card center">
<h2>Inserisci PIN</h2>
<h1 id="pinDisplay">‚Ä¢‚Ä¢‚Ä¢‚Ä¢</h1>

<div class="keyboard">
${[1,2,3,4,5,6,7,8,9].map(n=>`<button onclick="pressPin(${n})">${n}</button>`).join("")}
<button onclick="clearPin()">C</button>
<button onclick="pressPin(0)">0</button>
<button onclick="enterPin()">OK</button>
</div>
</div>
`;

window.tempPin="";
}

function pressPin(n){
tempPin+=n;
document.getElementById("pinDisplay").innerText=tempPin.replace(/./g,"‚Ä¢");
}

function clearPin(){
tempPin="";
document.getElementById("pinDisplay").innerText="‚Ä¢‚Ä¢‚Ä¢‚Ä¢";
}

function enterPin(){
if(tempPin===data.pin){
renderHome();
}else{
alert("PIN errato");
clearPin();
}
}

/* ---------- HOME ---------- */
function renderHome(){

document.getElementById("app").innerHTML=`

<div class="card" style="max-width:600px;margin:auto">

<h2>Nuovo Evento</h2>

<input id="evName" placeholder="Nome evento">

<select id="evType">
<option>Abbigliamento</option>
<option>Gadget</option>
<option>Bus</option>
</select>

<input id="evPrice" type="number" placeholder="Prezzo ‚Ç¨">
<input id="evSeats" type="number" placeholder="Posti Bus (solo Bus)">

<div style="display:flex;gap:10px">
<button class="primary" style="flex:1" onclick="addEvent()">Crea Evento</button>
<button class="gray" onclick="toggleDark()">üåô</button>
<button class="gray" onclick="exportData()">Backup</button>
</div>

<input type="file" onchange="importData(event)" style="margin-top:10px">

</div>

<div class="card" style="max-width:600px;margin:20px auto">
<h2>Eventi</h2>

${data.events.length==0?`<div>Nessun evento</div>`:
data.events.map((e,i)=>`
<div class="order-row">
<div>
<div style="font-weight:600">${e.name}</div>
<div style="font-size:13px;opacity:.6">${e.type}</div>
</div>
<div>
<button class="primary" onclick="openEvent(${i})">Apri</button>
<button class="red" onclick="deleteEvent(${i})">‚úï</button>
</div>
</div>
`).join("")
}

</div>
`;

if(data.dark)document.body.classList.add("dark");
else document.body.classList.remove("dark");

}

/* ---------- CREATE EVENT ---------- */
function addEvent(){
let name=evName.value;
let type=evType.value;
let price=parseFloat(evPrice.value)||0;
let seats=parseInt(evSeats.value)||0;

if(!name)return;

data.events.push({
name,type,price,seats,
orders:[]
});

save();
renderHome();
}

/* ---------- DELETE EVENT ---------- */
function deleteEvent(i){
if(confirm("Eliminare evento?")){
data.events.splice(i,1);
save();
renderHome();
}
}

/* ---------- OPEN EVENT ---------- */
function openEvent(i){
currentEvent=i;
editIndex=null;
renderEvent();
}

/* ---------- EVENT PAGE ---------- */
function renderEvent(){

let ev=data.events[currentEvent];

document.getElementById("app").innerHTML=`

<div class="card">

<h2>${ev.name} - ‚Ç¨${ev.price}</h2>

<input id="clientName" placeholder="Nome">

${ev.type==="Abbigliamento"?renderSizes():`
<input id="qty" type="number" placeholder="Quantit√†">
`}

<label><input type="checkbox" id="paid"> PAGATO</label>

<div style="margin-top:10px">
<button class="primary" onclick="saveOrder()">Salva</button>
<button class="gray" onclick="cancelEdit()">Annulla</button>
<button class="gray" onclick="renderHome()">Indietro</button>
</div>

</div>

<div class="card">
<h2>Ordini</h2>
${renderOrders()}
</div>

<div class="card">
<h2>Riepilogo Ordini</h2>
${renderSummary()}
<button onclick="window.print()">Stampa</button>
</div>
`;

}

/* ---------- SIZES ---------- */
function renderSizes(){
return ["XS","S","M","L","XL","XXL"].map(s=>
`<div style="display:flex;justify-content:space-between;margin-bottom:6px">
<label>${s}</label>
<select id="size_${s}">
${[0,1,2,3,4,5,6,7,8,9].map(n=>`<option>${n}</option>`).join("")}
</select>
</div>`
).join("");
}

/* ---------- SAVE ORDER ---------- */
function saveOrder(){

let ev=data.events[currentEvent];
let name=clientName.value;
if(!name)return;

let order={name,paid:paid.checked};

if(ev.type==="Abbigliamento"){
order.sizes={};
let total=0;
["XS","S","M","L","XL","XXL"].forEach(s=>{
let q=parseInt(document.getElementById("size_"+s).value);
if(q>0){order.sizes[s]=q;total+=q;}
});
order.total=total*ev.price;
}else{
let q=parseInt(qty.value)||0;
order.qty=q;
order.total=q*ev.price;
}

if(editIndex!==null){
ev.orders[editIndex]=order;
editIndex=null;
}else{
ev.orders.push(order);
}

save();
renderEvent();
}

/* ---------- RENDER ORDERS ---------- */
function renderOrders(){

let ev=data.events[currentEvent];

if(ev.orders.length==0)return "Nessun ordine";

return ev.orders.map((o,i)=>`

<div class="order-row ${editIndex===i?'highlight':''}">

<div style="flex:1">
<div style="font-weight:600">${o.name}</div>
<div style="font-size:14px">
${ev.type==="Abbigliamento"?
Object.entries(o.sizes).map(([k,v])=>`${v} ${k}`).join(" - ")
:
o.qty+" pezzi"
}
</div>
</div>

<div style="text-align:right">
<div>‚Ç¨ ${o.total}</div>
<div class="${o.paid?'green':''}">
${o.paid?"PAGATO":"NON PAGATO"}
</div>
</div>

<div style="display:flex;gap:6px;margin-left:10px">
<button onclick="editOrder(${i})">‚úèÔ∏è</button>
<button class="red" onclick="deleteOrder(${i})">üóë</button>
</div>

</div>

`).join("");
}

/* ---------- SUMMARY ---------- */
function renderSummary(){
let ev=data.events[currentEvent];

return ev.orders
.sort((a,b)=>a.name.localeCompare(b.name))
.map(o=>`
<div style="margin-bottom:8px">
<b>${o.name}</b><br>
${ev.type==="Abbigliamento"?
Object.entries(o.sizes).map(([k,v])=>`${v} ${k}`).join(" - ")
:
o.qty+" pezzi"
}
 - ‚Ç¨ ${o.total} - ${o.paid?"PAGATO":"NON PAGATO"}
</div>
`).join("");
}

/* ---------- EDIT ---------- */
function editOrder(i){
editIndex=i;
let o=data.events[currentEvent].orders[i];
document.getElementById("clientName").value=o.name;
paid.checked=o.paid;
window.scrollTo({top:0,behavior:'smooth'});
renderEvent();
}

/* ---------- DELETE ORDER ---------- */
function deleteOrder(i){
if(confirm("Eliminare ordine?")){
data.events[currentEvent].orders.splice(i,1);
save();
renderEvent();
}
}

function cancelEdit(){
editIndex=null;
renderEvent();
}

/* ---------- DARK ---------- */
function toggleDark(){
data.dark=!data.dark;
save();
renderHome();
}

/* ---------- BACKUP ---------- */
function exportData(){
let blob=new Blob([JSON.stringify(data)],{type:"application/json"});
let a=document.createElement("a");
a.href=URL.createObjectURL(blob);
a.download="giorders_backup.json";
a.click();
}

function importData(e){
let file=e.target.files[0];
let reader=new FileReader();
reader.onload=function(){
data=JSON.parse(reader.result);
save();
renderHome();
}
reader.readAsText(file);
}

/* ---------- INIT ---------- */
renderPin();

</script>
</body>
</html>
