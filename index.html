<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GiOrders Pro</title>

<style>
body{
    font-family:-apple-system,BlinkMacSystemFont,sans-serif;
    background:#f2f2f7;
    margin:0;
    padding:15px;
}

.dark{
    background:#111;
    color:white;
}

.card{
    background:white;
    padding:18px;
    border-radius:18px;
    margin-bottom:15px;
    box-shadow:0 5px 15px rgba(0,0,0,0.05);
}

.dark .card{
    background:#1c1c1e;
}

h2{
    text-align:center;
    margin-top:0;
}

input,select{
    width:100%;
    padding:10px;
    border-radius:12px;
    border:1px solid #ddd;
    margin-bottom:10px;
}

button{
    padding:10px;
    border:none;
    border-radius:12px;
    font-weight:600;
}

.primary{
    background:#007aff;
    color:white;
}

.gray{
    background:#d1d1d6;
}

.danger{
    background:#ff3b30;
    color:white;
}

.hidden{display:none}

/* SWITCH iPhone */
.switch{
    position:relative;
    display:inline-block;
    width:50px;
    height:28px;
}

.switch input{display:none;}

.slider{
    position:absolute;
    cursor:pointer;
    top:0;left:0;right:0;bottom:0;
    background:#ccc;
    border-radius:34px;
    transition:.3s;
}

.slider:before{
    position:absolute;
    content:"";
    height:22px;width:22px;
    left:3px;bottom:3px;
    background:white;
    border-radius:50%;
    transition:.3s;
}

input:checked + .slider{
    background:#34c759;
}

input:checked + .slider:before{
    transform:translateX(22px);
}

.paid-container{
    display:flex;
    justify-content:center;
    align-items:center;
    gap:15px;
    margin:15px 0;
    font-size:13px;
    font-weight:600;
}

.paid-label.left{color:#ff3b30;}
.paid-label.right{color:#34c759;}

.size-row{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:8px;
}

.size-row select{
    width:80px;
}

.order-row{
    padding:10px 0;
    border-bottom:1px solid #eee;
}

.order-header{
    display:flex;
    justify-content:space-between;
    font-weight:600;
}

.order-sub{
    display:flex;
    justify-content:space-between;
    font-size:14px;
}

.badge-paid{color:#34c759;font-weight:700;}
.badge-unpaid{color:#ff3b30;font-weight:700;}

.keypad{
    display:grid;
    grid-template-columns:repeat(3,1fr);
    gap:10px;
}

.keypad button{
    font-size:20px;
    padding:15px;
}

</style>
</head>

<body>

<div id="pinScreen"></div>
<div id="app" class="hidden"></div>

<script>
/* ===== STRUTTURA DATI ===== */

let data = JSON.parse(localStorage.getItem("giorders_pro")) || {
    settings:{
        pin:"1926",
        dark:false
    },
    events:[]
};

let currentEvent = null;
let editIndex = null;
let tempPin = "";

/* ===== SALVATAGGIO ===== */

function save(){
    localStorage.setItem("giorders_pro", JSON.stringify(data));
}

/* ===== PIN ===== */

function renderPin(){
    document.getElementById("pinScreen").innerHTML = `
        <div class="card">
            <h2>Inserisci PIN</h2>
            <div id="pinDisplay" style="text-align:center;font-size:28px;letter-spacing:8px;margin:15px 0;">----</div>
            <div class="keypad">
                ${[1,2,3,4,5,6,7,8,9].map(n=>`<button onclick="pressPin(${n})">${n}</button>`).join("")}
                <button onclick="clearPin()">C</button>
                <button onclick="pressPin(0)">0</button>
                <button onclick="checkPin()">OK</button>
            </div>
        </div>
    `;
}

function pressPin(n){
    if(tempPin.length < 4){
        tempPin += n;
        document.getElementById("pinDisplay").innerText = tempPin.padEnd(4,"-");
    }
}

function clearPin(){
    tempPin = "";
    document.getElementById("pinDisplay").innerText = "----";
}

function checkPin(){
    if(tempPin === data.settings.pin){
        document.getElementById("pinScreen").classList.add("hidden");
        document.getElementById("app").classList.remove("hidden");
        renderHome();
    } else {
        alert("PIN errato");
        clearPin();
    }
}

/* ===== HOME ===== */

function renderHome(){

    document.body.classList.toggle("dark", data.settings.dark);

    document.getElementById("app").innerHTML = `
        <div class="card">
            <h2>Nuovo Evento</h2>
            <input id="evName" placeholder="Nome evento">
            <select id="evType">
                <option value="Abbigliamento">Abbigliamento</option>
                <option value="Gadget">Gadget</option>
                <option value="Bus">Bus</option>
            </select>
            <input id="evPrice" type="number" placeholder="Prezzo â‚¬">
            <input id="evSeats" type="number" placeholder="Posti Bus (solo Bus)">
            <button class="primary" onclick="addEvent()">Crea Evento</button>
            <button class="gray" onclick="toggleDark()">ðŸŒ™ ModalitÃ  Scura</button>
        </div>

        <div class="card">
            <h2>Eventi</h2>
            ${
                data.events.length === 0
                ? "<p>Nessun evento creato</p>"
                : data.events.map((e,i)=>`
                    <div class="order-row">
                        <div class="order-header">
                            <div>${e.name}</div>
                            <div>${e.type}</div>
                        </div>
                        <div style="margin-top:8px;">
                            <button class="primary" onclick="openEvent(${i})">Apri</button>
                            <button class="danger" onclick="deleteEvent(${i})">Elimina</button>
                        </div>
                    </div>
                `).join("")
            }
        </div>
    `;
}

function addEvent(){
    let name = document.getElementById("evName").value.trim();
    let type = document.getElementById("evType").value;
    let price = parseFloat(document.getElementById("evPrice").value) || 0;
    let seats = parseInt(document.getElementById("evSeats").value) || 0;

    if(!name) return;

    data.events.push({
        name,
        type,
        price,
        seats,
        orders:[]
    });

    save();
    renderHome();
}

function deleteEvent(i){
    if(confirm("Eliminare evento?")){
        data.events.splice(i,1);
        save();
        renderHome();
    }
}

function openEvent(i){
    currentEvent = i;
    editIndex = null;
    renderEvent();
}

function toggleDark(){
    data.settings.dark = !data.settings.dark;
    save();
    renderHome();
}
/* ===== PAGINA EVENTO ===== */

function renderEvent(){

    let ev = data.events[currentEvent];

    document.getElementById("app").innerHTML = `
        <div class="card">
            <h2>${ev.name} - â‚¬${ev.price}</h2>

            <input id="clientName" placeholder="Nome">

            ${ev.type === "Abbigliamento" ? renderSizes() : `
                <input id="quantity" type="number" placeholder="QuantitÃ ">
            `}

            <div class="paid-container">
                <span class="paid-label left">NON PAGATO</span>

                <label class="switch">
                    <input type="checkbox" id="paidSwitch">
                    <span class="slider"></span>
                </label>

                <span class="paid-label right">PAGATO</span>
            </div>

            <button class="primary" onclick="saveOrder()">Salva</button>
            <button class="gray" onclick="cancelEdit()">Annulla</button>
            <button class="gray" onclick="renderHome()">Indietro</button>
        </div>

        <div class="card">
            <h2>Ordini</h2>
            ${renderOrders()}
            <button class="gray" onclick="toggleEmissione()">Emissione Ordine</button>
        </div>

        ${renderEmissione()}
    `;
}

/* ===== TAGLIE ===== */

function renderSizes(){
    let sizes = ["XS","S","M","L","XL","XXL"];
    return sizes.map(s=>`
        <div class="size-row">
            <div>${s}</div>
            <select id="size_${s}">
                ${[0,1,2,3,4,5,6,7,8,9,10]
                    .map(n=>`<option>${n}</option>`).join("")}
            </select>
        </div>
    `).join("");
}

/* ===== SALVA ORDINE ===== */

function saveOrder(){

    let ev = data.events[currentEvent];
    let name = document.getElementById("clientName").value.trim();
    if(!name) return;

    let order = {
        name,
        paid: document.getElementById("paidSwitch").checked
    };

    if(ev.type === "Abbigliamento"){
        order.sizes = {};
        let totalQty = 0;

        ["XS","S","M","L","XL","XXL"].forEach(s=>{
            let q = parseInt(document.getElementById("size_"+s).value);
            if(q > 0){
                order.sizes[s] = q;
                totalQty += q;
            }
        });

        if(totalQty === 0) return;
        order.total = totalQty * ev.price;

    } else {

        let q = parseInt(document.getElementById("quantity").value) || 0;
        if(q === 0) return;

        if(ev.type === "Bus"){
            let booked = ev.orders.reduce((a,b)=>a+(b.qty||0),0);
            if(booked + q > ev.seats){
                alert("Posti insufficienti");
                return;
            }
        }

        order.qty = q;
        order.total = q * ev.price;
    }

    if(editIndex !== null){
        ev.orders[editIndex] = order;
        editIndex = null;
    } else {
        ev.orders.push(order);
    }

    save();
    renderEvent();
}

/* ===== RENDER ORDINI ===== */

function renderOrders(){

    let ev = data.events[currentEvent];

    if(ev.orders.length === 0)
        return "<p>Nessun ordine</p>";

    return ev.orders.map((o,i)=>`
        <div class="order-row">
            <div class="order-header">
                <div>${o.name}</div>
                <div>â‚¬ ${o.total}</div>
            </div>
            <div class="order-sub">
                <div>
                    ${
                        ev.type==="Abbigliamento"
                        ? Object.entries(o.sizes)
                            .map(([k,v])=>`${v} ${k}`)
                            .join(" - ")
                        : o.qty + " pezzi"
                    }
                </div>
                <div class="${o.paid?'badge-paid':'badge-unpaid'}">
                    ${o.paid?'PAGATO':'NON PAGATO'}
                </div>
            </div>
            <div style="margin-top:6px;">
                <button onclick="editOrder(${i})">Modifica</button>
                <button class="danger" onclick="deleteOrder(${i})">Elimina</button>
                <button onclick="togglePaid(${i})">Toggle</button>
            </div>
        </div>
    `).join("");
}

/* ===== EMISSIONE ORDINE ===== */

function toggleEmissione(){
    let box = document.getElementById("emissioneBox");
    if(box) box.classList.toggle("hidden");
}

function renderEmissione(){

    let ev = data.events[currentEvent];
    let totals = {XS:0,S:0,M:0,L:0,XL:0,XXL:0};

    ev.orders.forEach(o=>{
        if(o.sizes){
            Object.keys(totals).forEach(size=>{
                totals[size] += o.sizes[size] || 0;
            });
        }
    });

    return `
        <div id="emissioneBox" class="card hidden">
            <h2>Emissione Ordine</h2>
            ${Object.entries(totals).map(([k,v])=>`
                <div>${k}: <b>${v}</b></div>
            `).join("")}
        </div>
    `;
}

/* ===== MODIFICA ===== */

function editOrder(i){
    editIndex = i;
    let o = data.events[currentEvent].orders[i];

    document.getElementById("clientName").value = o.name;
    document.getElementById("paidSwitch").checked = o.paid;

    if(o.sizes){
        Object.entries(o.sizes).forEach(([k,v])=>{
            document.getElementById("size_"+k).value = v;
        });
    }

    if(o.qty){
        document.getElementById("quantity").value = o.qty;
    }

    window.scrollTo({top:0,behavior:"smooth"});
}

/* ===== TOGGLE PAGATO ===== */

function togglePaid(i){
    data.events[currentEvent].orders[i].paid =
        !data.events[currentEvent].orders[i].paid;
    save();
    renderEvent();
}

/* ===== ELIMINA ORDINE ===== */

function deleteOrder(i){
    if(confirm("Eliminare ordine?")){
        data.events[currentEvent].orders.splice(i,1);
        save();
        renderEvent();
    }
}

/* ===== ANNULLA MODIFICA ===== */

function cancelEdit(){
    editIndex = null;
    renderEvent();
}

/* ===== AVVIO ===== */

renderPin();

</script>
</body>
</html>