<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GiOrders Pro</title>

<style>
body{
    margin:0;
    font-family:-apple-system,BlinkMacSystemFont;
    background:#f2f2f7;
}

.dark{
    background:#111;
    color:white;
}

.card{
    background:white;
    margin:20px;
    padding:20px;
    border-radius:18px;
    box-shadow:0 5px 20px rgba(0,0,0,0.08);
}

.dark .card{
    background:#1c1c1e;
}

h2{text-align:center;}

input,select{
    width:100%;
    padding:12px;
    border-radius:12px;
    border:1px solid #ddd;
    margin-bottom:12px;
}

button{
    padding:10px 14px;
    border:none;
    border-radius:12px;
    font-weight:600;
    cursor:pointer;
}

.primary{background:#007aff;color:white;}
.gray{background:#d1d1d6;}
.danger{background:#ff3b30;color:white;}

.hidden{display:none}

.paid-container{
    display:flex;
    justify-content:center;
    align-items:center;
    gap:12px;
    margin:15px 0;
}

.switch{
    position:relative;
    width:50px;
    height:28px;
}

.switch input{display:none;}

.slider{
    position:absolute;
    inset:0;
    background:#ccc;
    border-radius:34px;
    transition:.3s;
}

.slider:before{
    content:"";
    position:absolute;
    height:22px;
    width:22px;
    left:3px;
    top:3px;
    background:white;
    border-radius:50%;
    transition:.3s;
}

input:checked + .slider{
    background:#34c759;
}

input:checked + .slider:before{
    transform:translateX(22px);
}

.order-box{
    border-bottom:1px solid #eee;
    padding:10px 0;
}

.badge-paid{color:#34c759;font-weight:bold;}
.badge-unpaid{color:#ff3b30;font-weight:bold;}

.pinScreen{
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    height:100vh;
}

.pinDisplay{
    font-size:30px;
    letter-spacing:10px;
    margin-bottom:20px;
}

.keypad{
    display:grid;
    grid-template-columns:repeat(3,70px);
    gap:15px;
}

.keypad button{
    padding:18px;
    border-radius:50%;
}
</style>
</head>
<body>

<div id="pinScreen" class="pinScreen"></div>
<div id="app" class="hidden"></div>

<script>
let data = JSON.parse(localStorage.getItem("giorders")) || {
    settings:{ pin:"1926", dark:false },
    events:[]
};

let currentEvent = null;
let tempPin = "";
let editIndex = null;

function saveData(){
    localStorage.setItem("giorders", JSON.stringify(data));
}

function renderPin(){
    document.getElementById("pinScreen").innerHTML = `
        <h2>Inserisci PIN</h2>
        <div class="pinDisplay">${tempPin.replace(/./g,"‚Ä¢")}</div>
        <div class="keypad">
            ${[1,2,3,4,5,6,7,8,9].map(n=>`<button onclick="pressPin(${n})">${n}</button>`).join("")}
            <button onclick="clearPin()">C</button>
            <button onclick="pressPin(0)">0</button>
            <button onclick="checkPin()">OK</button>
        </div>
    `;
}

function pressPin(n){
    if(tempPin.length<4){
        tempPin+=n;
        renderPin();
    }
}

function clearPin(){
    tempPin="";
    renderPin();
}

function checkPin(){
    if(tempPin===data.settings.pin){
        document.getElementById("pinScreen").classList.add("hidden");
        document.getElementById("app").classList.remove("hidden");
        renderHome();
    }else{
        alert("PIN errato");
        clearPin();
    }
}

function renderHome(){
    document.getElementById("app").innerHTML = `
    <div class="card">
        <h2>Nuovo Evento</h2>
        <input id="evName" placeholder="Nome evento">
        <select id="evType">
            <option value="Abbigliamento">Abbigliamento</option>
            <option value="Gadget">Gadget</option>
            <option value="Bus">Bus</option>
        </select>
        <input id="evPrice" type="number" placeholder="Prezzo ‚Ç¨">
        <input id="evSeats" type="number" placeholder="Posti Bus (solo Bus)">
        <button class="primary" onclick="createEvent()">Crea Evento</button>
        <button class="gray" onclick="toggleDark()">üåô Modalit√†</button>
        <button class="gray" onclick="changePin()">üîê Cambia PIN</button>
    </div>

    <div class="card">
        <h2>Eventi</h2>
        ${renderEventList()}
    </div>
    `;
}

function createEvent(){
    let name=document.getElementById("evName").value;
    let type=document.getElementById("evType").value;
    let price=parseFloat(document.getElementById("evPrice").value)||0;
    let seats=parseInt(document.getElementById("evSeats").value)||0;

    if(!name) return alert("Inserisci nome evento");

    data.events.push({ name,type,price,seats,orders:[] });
    saveData();
    renderHome();
}

function renderEventList(){
    if(data.events.length===0) return "Nessun evento";

    return data.events.map((ev,i)=>`
        <div class="order-box">
            <strong>${ev.name}</strong> (${ev.type})
            <div style="margin-top:8px">
                <button class="primary" onclick="openEvent(${i})">Apri</button>
                <button class="danger" onclick="deleteEvent(${i})">Elimina</button>
            </div>
        </div>
    `).join("");
}

function openEvent(i){
    currentEvent=i;
    editIndex=null;
    renderEvent();
}

function deleteEvent(i){
    if(confirm("Eliminare evento?")){
        data.events.splice(i,1);
        saveData();
        renderHome();
    }
}

function toggleDark(){
    document.body.classList.toggle("dark");
    data.settings.dark=!data.settings.dark;
    saveData();
}

function changePin(){
    let newPin=prompt("Nuovo PIN 4 cifre");
    if(newPin && newPin.length===4){
        data.settings.pin=newPin;
        saveData();
        alert("PIN aggiornato");
    }
}
function renderEvent(){
    let ev=data.events[currentEvent];

    document.getElementById("app").innerHTML=`
    <div class="card">
        <h2>${ev.name} - ‚Ç¨${ev.price}</h2>

        <input id="clientName" placeholder="Nome">

        ${ev.type==="Abbigliamento"?renderSizes():`<input id="quantity" type="number" placeholder="Quantit√†">`}

        <div class="paid-container">
            <span style="color:#ff3b30">NON PAGATO</span>
            <label class="switch">
                <input type="checkbox" id="paidSwitch">
                <span class="slider"></span>
            </label>
            <span style="color:#34c759">PAGATO</span>
        </div>

        <button class="primary" onclick="saveOrder()">Salva</button>
        <button class="gray" onclick="renderHome()">Indietro</button>
    </div>

    <div class="card">
        <h2>Ordini</h2>
        ${renderOrders()}
    </div>

    <div class="card">
        <h2>Emissione Ordine</h2>
        ${renderEmission()}
    </div>
    `;
}

function renderSizes(){
    const sizes=["XS","S","M","L","XL","XXL","XXXL"];
    return sizes.map(s=>`
        <div style="display:flex;justify-content:space-between;margin:6px 0">
            <span>${s}</span>
            <select id="size_${s}" style="width:70px">
                ${Array.from({length:21},(_,i)=>`<option value="${i}">${i}</option>`).join("")}
            </select>
        </div>
    `).join("");
}

function saveOrder(){
    let ev=data.events[currentEvent];
    let name=document.getElementById("clientName").value;
    let paid=document.getElementById("paidSwitch").checked;

    if(!name) return alert("Inserisci nome");

    let order={ name, paid, items:{} };

    if(ev.type==="Abbigliamento"){
        ["XS","S","M","L","XL","XXL","XXXL"].forEach(s=>{
            let q=parseInt(document.getElementById("size_"+s).value)||0;
            if(q>0) order.items[s]=q;
        });
    }else{
        let q=parseInt(document.getElementById("quantity").value)||0;
        if(q>0) order.items["Q"]=q;
    }

    ev.orders.push(order);
    saveData();
    renderEvent();
}
function renderOrders(){
    let ev=data.events[currentEvent];
    if(ev.orders.length===0) return "Nessun ordine";

    return ev.orders.map((o,i)=>`
        <div class="order-box">
            <strong>${o.name}</strong><br>
            ${Object.keys(o.items).map(k=>`${o.items[k]} ${k}`).join(" - ")}
            <br>
            ‚Ç¨ ${calculateTotal(o)} -
            <span class="${o.paid?'badge-paid':'badge-unpaid'}">
                ${o.paid?'PAGATO':'NON PAGATO'}
            </span>
            <div style="margin-top:8px">
                <button onclick="togglePaid(${i})">Toggle</button>
                <button class="danger" onclick="deleteOrder(${i})">Elimina</button>
            </div>
        </div>
    `).join("");
}

function calculateTotal(o){
    let ev=data.events[currentEvent];
    let tot=0;
    Object.values(o.items).forEach(q=>tot+=q*ev.price);
    return tot;
}

function togglePaid(i){
    let ev=data.events[currentEvent];
    ev.orders[i].paid=!ev.orders[i].paid;
    saveData();
    renderEvent();
}

function deleteOrder(i){
    let ev=data.events[currentEvent];
    ev.orders.splice(i,1);
    saveData();
    renderEvent();
}

function renderEmission(){
    let ev=data.events[currentEvent];
    let totals={};

    ev.orders.forEach(o=>{
        Object.keys(o.items).forEach(k=>{
            totals[k]=(totals[k]||0)+o.items[k];
        });
    });

    if(Object.keys(totals).length===0) return "Nessun dato";

    return Object.keys(totals).map(k=>`
        <div>${k}: ${totals[k]} pezzi</div>
    `).join("");
}

renderPin();
</script>
</body>
</html>