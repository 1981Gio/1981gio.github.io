<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GiOrders</title>

<meta name="apple-mobile-web-app-capable" content="yes">
<link rel="apple-touch-icon" href="1FFB8DDC-1EC1-4569-971E-598213CC5587.png">

<style>
:root{
  --bg:#f2f2f7;
  --card:#ffffff;
  --text:#000;
}
.dark{
  --bg:#1c1c1e;
  --card:#2c2c2e;
  --text:#fff;
}
body{
  font-family:-apple-system,sans-serif;
  background:var(--bg);
  color:var(--text);
  padding:16px;
}
h1{text-align:center;color:#0A84FF;}
.card{
  background:var(--card);
  padding:16px;
  border-radius:16px;
  margin-bottom:16px;
  box-shadow:0 6px 18px rgba(0,0,0,0.08);
}
button{
  padding:8px 12px;
  border:none;
  border-radius:10px;
  font-size:13px;
  margin-top:6px;
}
.primary{background:#0A84FF;color:white;}
.red{background:#ff3b30;color:white;}
.green{background:#34c759;color:white;}
input,select{
  width:100%;
  padding:8px;
  margin-bottom:8px;
  border-radius:10px;
  border:1px solid #ccc;
}
.row{display:flex;gap:8px;align-items:center;}
.switch{
  position:relative;
  display:inline-block;
  width:40px;
  height:22px;
}
.switch input{opacity:0;width:0;height:0;}
.slider{
  position:absolute;
  cursor:pointer;
  top:0;left:0;right:0;bottom:0;
  background-color:#ccc;
  transition:.3s;
  border-radius:22px;
}
.slider:before{
  position:absolute;
  content:"";
  height:16px;width:16px;
  left:3px;bottom:3px;
  background:white;
  transition:.3s;
  border-radius:50%;
}
input:checked + .slider{
  background:#34c759;
}
input:checked + .slider:before{
  transform:translateX(18px);
}
.summary-box{
  background:#f4f4f6;
  padding:10px;
  border-radius:10px;
  margin-bottom:6px;
}
@media print{
  button,.switch{display:none;}
}
</style>
</head>

<body>

<div id="login"></div>
<div id="app" style="display:none;"></div>

<script>

/* ================= PIN SYSTEM ================= */

let savedPIN = localStorage.getItem("gi_pin") || "1234";

function renderLogin(){
  login.innerHTML=`
  <div class="card">
    <h3>Accesso GiOrders</h3>
    <input type="password" id="pinInput" placeholder="Inserisci PIN">
    <button class="primary" onclick="checkPIN()">Accedi</button>
  </div>`;
}

function checkPIN(){
  if(pinInput.value===savedPIN){
    login.style.display="none";
    app.style.display="block";
    renderHome();
  }else{
    alert("PIN errato");
  }
}

function cambiaPIN(){
  let nuovo = prompt("Inserisci nuovo PIN (min 4 cifre)");
  if(nuovo && nuovo.length>=4){
    localStorage.setItem("gi_pin",nuovo);
    savedPIN=nuovo;
    alert("PIN aggiornato");
  }
}

/* ================= APP CORE ================= */

let eventi = JSON.parse(localStorage.getItem("gi_eventi")) || {};
let eventoCorrente=null;
let taglie=["XS","S","M","L","XL","XXL"];

function salva(){
  localStorage.setItem("gi_eventi",JSON.stringify(eventi));
}

/* HOME */

function renderHome(){
  let html=`
  <div class="card">
    <button onclick="toggleDark()">üåô Modalit√†</button>
    <button onclick="cambiaPIN()">üîê Cambia PIN</button>
    <h3>Crea Evento</h3>
    <input id="nomeEvento" placeholder="Nome Evento">
    <select id="tipoEvento">
      <option value="maglia">Abbigliamento</option>
      <option value="oggetto">Gadget</option>
    </select>
    <input type="number" id="prezzoEvento" placeholder="Prezzo fisso ‚Ç¨">
    <button class="primary" onclick="creaEvento()">Crea Evento</button>
  </div>

  <div class="card">
    <h3>Eventi</h3>
  `;

  for(let nome in eventi){
    html+=`
    <div class="row">
      <button style="flex:1" onclick="apriEvento('${nome}')">${nome}</button>
      <button class="red" onclick="eliminaEvento('${nome}')">X</button>
    </div>`;
  }

  html+=`</div>`;
  app.innerHTML=html;
}

function creaEvento(){
  let nome=nomeEvento.value;
  let tipo=tipoEvento.value;
  let prezzo=parseFloat(prezzoEvento.value);
  if(!nome||!prezzo)return;
  eventi[nome]={tipo,prezzo,ordini:[]};
  salva();
  renderHome();
}

function eliminaEvento(nome){
  if(confirm("Eliminare evento "+nome+" ?")){
    delete eventi[nome];
    salva();
    renderHome();
  }
}

function apriEvento(nome){
  eventoCorrente=nome;
  renderEvento();
}

/* EVENTO */

function renderEvento(){
  let ev=eventi[eventoCorrente];

  let html=`
  <div class="card">
    <button onclick="renderHome()">‚Üê Torna</button>
    <h3>${eventoCorrente}</h3>
    <p><strong>Prezzo:</strong> ‚Ç¨ ${ev.prezzo}</p>
  </div>

  <div class="card">
    <h3>Nuovo Ordine</h3>
    <input id="cliente" placeholder="Nome Cliente">
  `;

  if(ev.tipo==="maglia"){
    taglie.forEach(t=>{
      html+=`
      <div class="row">
        <div style="flex:1">${t}</div>
        <select id="q_${t}" style="flex:1">
          <option value="0">0</option>
          ${[1,2,3,4,5,6,7,8,9].map(n=>`<option>${n}</option>`).join("")}
        </select>
      </div>`;
    });
  }else{
    html+=`
    <select id="q_obj">
      <option value="0">Quantit√†</option>
      ${[1,2,3,4,5,6,7,8,9].map(n=>`<option>${n}</option>`).join("")}
    </select>`;
  }

  html+=`
    <button class="primary" onclick="aggiungiOrdine()">Aggiungi</button>
  </div>

  <div class="card">
    <h3>Storico Ordini</h3>
    <div id="listaOrdini"></div>
  </div>

  <div class="card">
    <h3>Riepilogo Evento</h3>
    <div id="riepilogo"></div>
  </div>

  <div class="card">
    <h3>Riepilogo Ordini (Alfabetico)</h3>
    <div id="riepilogoOrdini"></div>
    <button class="primary" onclick="window.print()">Stampa Completa</button>
  </div>
  `;

  app.innerHTML=html;
  aggiornaEvento();
}

function aggiungiOrdine(){
  let ev=eventi[eventoCorrente];
  let nome=cliente.value;
  if(!nome)return;

  let dettagli={},totale=0;

  if(ev.tipo==="maglia"){
    taglie.forEach(t=>{
      let q=parseInt(document.getElementById("q_"+t).value);
      if(q>0){
        dettagli[t]=q;
        totale+=q*ev.prezzo;
        document.getElementById("q_"+t).value="0";
      }
    });
  }else{
    let q=parseInt(q_obj.value);
    if(q>0){
      dettagli["pezzi"]=q;
      totale+=q*ev.prezzo;
      q_obj.value="0";
    }
  }

  cliente.value="";
  ev.ordini.push({nome,dettagli,totale,pagato:false});
  salva();
  aggiornaEvento();
}

function aggiornaEvento(){
  let ev=eventi[eventoCorrente];
  let lista=document.getElementById("listaOrdini");
  let riepilogo=document.getElementById("riepilogo");
  let riepilogoOrdini=document.getElementById("riepilogoOrdini");

  lista.innerHTML="";
  let inc=0,nonInc=0;
  let riepilogoTaglie={};

  ev.ordini.forEach((o,i)=>{
    if(o.pagato)inc+=o.totale;
    else nonInc+=o.totale;

    for(let k in o.dettagli){
      if(ev.tipo==="maglia")
        riepilogoTaglie[k]=(riepilogoTaglie[k]||0)+o.dettagli[k];
    }

    lista.innerHTML+=`
    <div class="row">
      <div style="flex:1">${o.nome} - ‚Ç¨ ${o.totale}</div>
      <label class="switch">
        <input type="checkbox" ${o.pagato?'checked':''}
        onchange="togglePagato(${i})">
        <span class="slider"></span>
      </label>
    </div>`;
  });

  let htmlR=`
    <div class="summary-box">Incassato: ‚Ç¨ ${inc}</div>
    <div class="summary-box">Da Incassare: ‚Ç¨ ${nonInc}</div>`;

  for(let t in riepilogoTaglie){
    htmlR+=`<div class="summary-box">Totale ${t}: ${riepilogoTaglie[t]}</div>`;
  }

  riepilogo.innerHTML=htmlR;

  let ordinati=[...ev.ordini].sort((a,b)=>a.nome.localeCompare(b.nome));
  riepilogoOrdini.innerHTML="";
  ordinati.forEach(o=>{
    let dettagli="";
    for(let k in o.dettagli){
      dettagli+=`${o.dettagli[k]} ${k} `;
    }
    riepilogoOrdini.innerHTML+=`
      <div class="summary-box">
        <strong>${o.nome}</strong> - ${dettagli}
      </div>`;
  });
}

function togglePagato(i){
  eventi[eventoCorrente].ordini[i].pagato=
  !eventi[eventoCorrente].ordini[i].pagato;
  salva();
  aggiornaEvento();
}

function toggleDark(){
  document.body.classList.toggle("dark");
}

renderLogin();

</script>

</body>
</html>
