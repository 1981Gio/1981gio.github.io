<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>GiOrders Pro</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0A84FF">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="apple-touch-icon.png">

<style>
body{
margin:0;
font-family:-apple-system;
background:#f2f2f7;
transition:.3s;
}
.dark{background:#1c1c1e;color:white;}

.card{
background:white;
margin:15px;
padding:15px;
border-radius:16px;
box-shadow:0 4px 12px rgba(0,0,0,.1);
transition:.3s;
}
.dark .card{background:#2c2c2e;}

button{
padding:8px 12px;
border:none;
border-radius:8px;
cursor:pointer;
margin:3px 0;
}

.primary{background:#0A84FF;color:white;}
.red{background:#ff3b30;color:white;}
.green{background:#34c759;color:white;}
.gray{background:#d1d1d6;}

input,select{
padding:6px;
border-radius:6px;
border:1px solid #ccc;
margin-bottom:8px;
}

.row{
margin-bottom:12px;
padding:12px;
border-radius:12px;
background:#f9f9fb;
transition:.3s;
}
.dark .row{background:#3a3a3c;}
.editing{background:#fff3cd !important;}

.orderTop{
font-weight:bold;
font-size:16px;
margin-bottom:4px;
}

.orderBottom{
display:flex;
justify-content:space-between;
font-size:14px;
}

.statusPaid{color:#34c759;font-weight:bold;}
.statusUnpaid{color:#ff3b30;font-weight:bold;}

.busBar{
height:18px;
background:#e5e5ea;
border-radius:10px;
overflow:hidden;
margin-top:6px;
}
.busFill{
height:100%;
background:#0A84FF;
width:0%;
transition:.4s;
}

.pinPad button{
font-size:20px;
padding:15px;
}

@media print{
button{display:none;}
body{background:white;}
}
</style>
</head>

<body>

<div id="login"></div>
<div id="app" style="display:none;"></div>

<script>

/* ================= CORE ================= */

let savedPIN = localStorage.getItem("pin") || "1926";
let eventi = JSON.parse(localStorage.getItem("eventi")||"{}");
let eventoCorrente = null;
let indiceModifica = null;
let taglie = ["XS","S","M","L","XL","XXL"];

function salva(){
localStorage.setItem("eventi",JSON.stringify(eventi));
}

/* ================= PIN ================= */

let pinInput="";

function renderLogin(){
login.innerHTML=`
<div class="card" style="text-align:center;">
<h2>GiOrders Pro</h2>
<div id="dots" style="font-size:28px;letter-spacing:8px;margin:20px;">â—‹ â—‹ â—‹ â—‹</div>
<div class="pinPad" style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;">
${[1,2,3,4,5,6,7,8,9].map(n=>`<button onclick="digit(${n})">${n}</button>`).join("")}
<button onclick="del()">âŒ«</button>
<button onclick="digit(0)">0</button>
<button onclick="clearPin()">C</button>
</div>
</div>`;
}

function digit(n){
if(pinInput.length>=4)return;
pinInput+=n;updateDots();
if(pinInput.length===4)setTimeout(checkPin,200);
}
function del(){pinInput=pinInput.slice(0,-1);updateDots();}
function clearPin(){pinInput="";updateDots();}
function updateDots(){
dots.innerHTML=[0,1,2,3].map(i=>i<pinInput.length?"â—":"â—‹").join(" ");
}
function checkPin(){
if(pinInput===savedPIN){
login.style.display="none";
app.style.display="block";
renderHome();
}else{
alert("PIN errato");pinInput="";updateDots();
}
}

/* ================= HOME ================= */

function renderHome(){
app.innerHTML=`
<div class="card">
<h3>Nuovo Evento</h3>
<input id="nomeEvento" placeholder="Nome evento"><br>
<select id="tipoEvento">
<option value="abbigliamento">Abbigliamento</option>
<option value="gadget">Gadget</option>
<option value="bus">Bus</option>
</select><br>
<input id="prezzoEvento" type="number" placeholder="Prezzo unitario"><br>
<input id="postiBus" type="number" placeholder="Posti totali (solo Bus)"><br>
<button class="primary" onclick="creaEvento()">Crea Evento</button>
<button onclick="toggleDark()">ðŸŒ™</button>
</div>

${Object.keys(eventi).map(e=>`
<div class="card">
<b>${e}</b><br>
<button onclick="entraEvento('${e}')">Apri</button>
<button class="red" onclick="eliminaEvento('${e}')">Elimina</button>
</div>
`).join("")}
`;
}

function creaEvento(){
let nome=nomeEvento.value;
let tipo=tipoEvento.value;
let prezzo=parseFloat(prezzoEvento.value||0);
let posti=parseInt(postiBus.value||0);

if(!nome)return;

eventi[nome]={
tipo,
prezzo,
postiTotali: tipo==="bus"?posti:0,
ordini:[]
};

salva();
renderHome();
}

/* ================= EVENTO ================= */

function entraEvento(n){
eventoCorrente=n;
renderEvento();
}

function renderEvento(){
let ev=eventi[eventoCorrente];

app.innerHTML=`
<div class="card">
<h3>${eventoCorrente}</h3>
Prezzo â‚¬ ${ev.prezzo}<br>
<button onclick="renderHome()">Indietro</button>
<button onclick="window.print()">ðŸ–¨ Stampa</button>
</div>

<div class="card">
<input id="cliente" placeholder="Nome cliente"><br>
<select id="quantita">
${[0,1,2,3,4,5,6,7,8,9,10].map(n=>`<option>${n}</option>`)}
</select><br>
<button class="primary" onclick="aggiungiOrdine()">Aggiungi</button>
</div>

${ev.tipo==="bus"?`
<div class="card">
<h3>Posti Bus</h3>
<div id="busInfo"></div>
<div class="busBar"><div id="busFill" class="busFill"></div></div>
</div>`:""}

<div class="card">
<h3>Ordini</h3>
<div id="listaOrdini"></div>
</div>

<div class="card">
<h3>Riepilogo Ordini (A-Z)</h3>
<div id="riepilogo"></div>
</div>
`;

aggiornaEvento();
}

/* ================= ORDINI ================= */

function aggiungiOrdine(){
let ev=eventi[eventoCorrente];
let nome=cliente.value;
let q=parseInt(quantita.value);

if(!nome||q<=0)return;

if(ev.tipo==="bus"){
let prenotati=ev.ordini.reduce((t,o)=>t+o.q,0);
if(prenotati+q>ev.postiTotali){
alert("Posti insufficienti!");
return;
}
}

ev.ordini.push({nome,q,pagato:false});
salva();
aggiornaEvento();
}

/* ================= UPDATE ================= */

function aggiornaEvento(){
let ev=eventi[eventoCorrente];

let prenotati=0;
listaOrdini.innerHTML=ev.ordini.map((o,i)=>{
prenotati+=o.q;
return `
<div class="row">
<div class="orderTop">${o.nome}</div>
<div class="orderBottom">
<div>${o.q} pezzi</div>
<div>
<span class="${o.pagato?"statusPaid":"statusUnpaid"}">
${o.pagato?"PAGATO":"NON PAGATO"}
</span>
</div>
</div>
<button onclick="togglePagato(${i})">Toggle</button>
<button class="red" onclick="eliminaOrdine(${i})">ðŸ—‘</button>
</div>`;
}).join("");

if(ev.tipo==="bus"){
busInfo.innerHTML=`
Totali: ${ev.postiTotali}<br>
Prenotati: ${prenotati}<br>
Disponibili: ${ev.postiTotali-prenotati}
`;
busFill.style.width=((prenotati/ev.postiTotali)*100)+"%";
}

let ordinati=[...ev.ordini].sort((a,b)=>a.nome.localeCompare(b.nome));
riepilogo.innerHTML=ordinati.map(o=>`
<div class="row">
<div class="orderTop">${o.nome}</div>
<div class="orderBottom">
<div>${o.q} pezzi</div>
<div>
<span class="${o.pagato?"statusPaid":"statusUnpaid"}">
${o.pagato?"PAGATO":"NON PAGATO"}
</span>
</div>
</div>
</div>
`).join("");
}

function togglePagato(i){
eventi[eventoCorrente].ordini[i].pagato=
!eventi[eventoCorrente].ordini[i].pagato;
salva();aggiornaEvento();
}

function eliminaOrdine(i){
eventi[eventoCorrente].ordini.splice(i,1);
salva();aggiornaEvento();
}

function toggleDark(){document.body.classList.toggle("dark");}

renderLogin();

</script>
</body>
</html>
