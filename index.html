<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GiOrders Pro</title>

<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="1FFB8DDC-1EC1-4569-971E-598213CC5587.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0A84FF">

<style>
body{font-family:-apple-system;margin:0;background:#f2f2f7}
.dark{background:#111;color:white}
.card{background:white;margin:15px;padding:16px;border-radius:16px;box-shadow:0 4px 12px rgba(0,0,0,.06)}
.dark .card{background:#1c1c1e}
button{padding:6px 10px;border:none;border-radius:8px;font-size:13px;cursor:pointer}
.primary{background:#0A84FF;color:white}
.red{background:#ff3b30;color:white}
.green{background:#34c759;color:white}
.gray{background:#d1d1d6}
input,select{padding:6px;border-radius:8px;border:1px solid #ccc;font-size:14px}
.row{margin-bottom:8px;padding:6px 0;border-bottom:1px solid #eee}
.orderTop{display:flex;justify-content:space-between;font-weight:600}
.orderBottom{display:flex;justify-content:space-between;font-size:14px}
.statusPaid{color:#34c759;font-weight:600}
.statusUnpaid{color:#ff3b30;font-weight:600}
.pin-screen{position:fixed;inset:0;background:#0A84FF;color:white;display:flex;flex-direction:column;justify-content:center;align-items:center}
.keypad{display:grid;grid-template-columns:repeat(3,70px);gap:10px}
.keypad button{font-size:20px;padding:15px;background:#004aad;color:white}
.hidden{display:none}
@media print{button{display:none}body{background:white}}
</style>
</head>
<body>

<div id="pinScreen" class="pin-screen">
<h2>Inserisci PIN</h2>
<div id="pinDisplay" style="font-size:32px;letter-spacing:10px;margin:20px">----</div>
<div class="keypad">
<button onclick="press(1)">1</button>
<button onclick="press(2)">2</button>
<button onclick="press(3)">3</button>
<button onclick="press(4)">4</button>
<button onclick="press(5)">5</button>
<button onclick="press(6)">6</button>
<button onclick="press(7)">7</button>
<button onclick="press(8)">8</button>
<button onclick="press(9)">9</button>
<button onclick="clearPin()">C</button>
<button onclick="press(0)">0</button>
<button onclick="checkPin()">OK</button>
</div>
</div>

<div id="app" class="hidden"></div>

<script>

let data = JSON.parse(localStorage.getItem("gioData") || JSON.stringify({
  settings:{pin:"1926",dark:false},
  events:[]
}));

let currentEvent=null;
let pinInput="";

function save(){localStorage.setItem("gioData",JSON.stringify(data));}

function press(n){if(pinInput.length<4){pinInput+=n;updatePin();}}
function clearPin(){pinInput="";updatePin();}
function updatePin(){document.getElementById("pinDisplay").innerText=pinInput.padEnd(4,"-");}
function checkPin(){
 if(pinInput===data.settings.pin){
  document.getElementById("pinScreen").classList.add("hidden");
  document.getElementById("app").classList.remove("hidden");
  renderHome();
 } else alert("PIN errato");
}

function renderHome(){
document.getElementById("app").innerHTML=`
<div class="card">
<h2>Eventi</h2>
<input id="evName" placeholder="Nome evento"><br>
<select id="evType">
<option>Abbigliamento</option>
<option>Gadget</option>
<option>Bus</option>
</select><br>
<input id="evPrice" type="number" placeholder="Prezzo â‚¬"><br>
<input id="evSeats" type="number" placeholder="Posti Bus (solo Bus)"><br>
<button class="primary" onclick="addEvent()">Crea</button>
<button onclick="toggleDark()">ðŸŒ™</button>
<button onclick="exportData()">Backup</button>
<input type="file" onchange="importData(event)">
</div>
${data.events.map((e,i)=>`
<div class="card">
<b>${e.name}</b>
<button onclick="openEvent(${i})">Apri</button>
<button class="red" onclick="delEvent(${i})">Elimina</button>
</div>`).join("")}
`;
if(data.settings.dark)document.body.classList.add("dark");
}

function toggleDark(){data.settings.dark=!data.settings.dark;save();renderHome();}

function addEvent(){
let name=evName.value;if(!name)return;
data.events.push({
 name,
 type:evType.value,
 price:parseFloat(evPrice.value||0),
 seats:parseInt(evSeats.value||0),
 orders:[]
});
save();renderHome();
}

function delEvent(i){if(confirm("Eliminare?")){data.events.splice(i,1);save();renderHome();}}

function openEvent(i){
currentEvent=i;
let ev=data.events[i];
document.getElementById("app").innerHTML=`
<div class="card">
<h2>${ev.name} - â‚¬${ev.price}</h2>
<input id="custName" placeholder="Nome"><br>
<input id="quantity" type="number" min="1" placeholder="QuantitÃ "><br>
<label>Pagato</label> <input type="checkbox" id="paid"><br>
<button class="primary" onclick="saveOrder()">Salva</button>
<button onclick="renderHome()">Indietro</button>
<button onclick="window.print()">Stampa</button>
</div>
<div class="card"><h3>Ordini</h3><div id="orders"></div></div>
<div class="card"><h3>Riepilogo</h3><div id="summary"></div></div>
`;
renderOrders();
}

function saveOrder(){
let ev=data.events[currentEvent];
let name=custName.value;
let q=parseInt(quantity.value);
if(!name||!q)return;
if(ev.type==="Bus"){
 let booked=ev.orders.reduce((a,b)=>a+b.quantity,0);
 if(booked+q>ev.seats){alert("Posti insufficienti");return;}
}
ev.orders.push({name,quantity:q,total:q*ev.price,paid:paid.checked});
save();renderOrders();custName.value="";quantity.value="";
}

function renderOrders(){
let ev=data.events[currentEvent];
let container=document.getElementById("orders");
container.innerHTML="";
ev.orders.forEach((o,i)=>{
container.innerHTML+=`
<div class="row">
<div class="orderTop">
 <div>${o.name}</div>
 <div>â‚¬ ${o.total}</div>
</div>
<div class="orderBottom">
 <div>${o.quantity} pezzi</div>
 <div class="${o.paid?'statusPaid':'statusUnpaid'}">${o.paid?'PAGATO':'NON PAGATO'}</div>
</div>
</div>`;
});
renderSummary();
}

function renderSummary(){
let ev=data.events[currentEvent];
let sum=document.getElementById("summary");
let sorted=[...ev.orders].sort((a,b)=>a.name.localeCompare(b.name));
sum.innerHTML="";
sorted.forEach(o=>{
sum.innerHTML+=`
<div class="row">
<div class="orderTop">
 <div>${o.name}</div>
 <div>â‚¬ ${o.total}</div>
</div>
<div class="orderBottom">
 <div>${o.quantity} pezzi</div>
 <div class="${o.paid?'statusPaid':'statusUnpaid'}">${o.paid?'PAGATO':'NON PAGATO'}</div>
</div>
</div>`;
});
}

function exportData(){
let blob=new Blob([JSON.stringify(data)],{type:"application/json"});
let a=document.createElement("a");
a.href=URL.createObjectURL(blob);
a.download="giorders_backup.json";
a.click();
}

function importData(e){
let reader=new FileReader();
reader.onload=function(){data=JSON.parse(reader.result);save();renderHome();};
reader.readAsText(e.target.files[0]);
}

if('serviceWorker' in navigator){
 navigator.serviceWorker.register('sw.js');
}

</script>
</body>
</html>
