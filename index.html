<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GiOrders Pro</title>

<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="1FFB8DDC-1EC1-4569-971E-598213CC5587.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<style>
body{
  font-family:-apple-system,BlinkMacSystemFont;
  margin:0;
  background:#f2f2f7;
}
.dark body{background:#0f172a;color:white}

.card{
  background:white;
  padding:15px;
  margin:15px;
  border-radius:16px;
  box-shadow:0 4px 12px rgba(0,0,0,0.08);
}
.dark .card{background:#1e293b}

h2{margin-top:0}

button{
  padding:8px 12px;
  border:none;
  border-radius:8px;
  margin:4px;
  cursor:pointer;
}

.primary{background:#0A84FF;color:white}
.red{background:#ff3b30;color:white}
.green{background:#34c759;color:white}
.gray{background:#d1d1d6}

input,select{
  padding:6px;
  border-radius:8px;
  border:1px solid #ccc;
}

.row{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:6px;
}

.highlight{background:#fff9c4}

.pin-screen{
  position:fixed;
  inset:0;
  background:#0f172a;
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  color:white;
}

.pin-display{
  font-size:32px;
  letter-spacing:10px;
  margin-bottom:20px;
}

.keypad{
  display:grid;
  grid-template-columns:repeat(3,70px);
  gap:10px;
}

.keypad button{
  font-size:20px;
  padding:15px;
  background:#1e293b;
  color:white;
}

.hidden{display:none}

.order-line{
  padding:8px 0;
  border-bottom:1px solid #ddd;
}

.status{
  font-weight:bold;
}

.paid{color:#34c759}
.unpaid{color:#ff3b30}

.bus-counter{
  font-weight:bold;
  margin-top:10px;
}

</style>
</head>

<body>

<div id="pinScreen" class="pin-screen">
<h2>Inserisci PIN</h2>
<div id="pinDisplay" class="pin-display">----</div>
<div class="keypad">
<button onclick="press(1)">1</button>
<button onclick="press(2)">2</button>
<button onclick="press(3)">3</button>
<button onclick="press(4)">4</button>
<button onclick="press(5)">5</button>
<button onclick="press(6)">6</button>
<button onclick="press(7)">7</button>
<button onclick="press(8)">8</button>
<button onclick="press(9)">9</button>
<button onclick="clearPin()">C</button>
<button onclick="press(0)">0</button>
<button onclick="checkPin()">OK</button>
</div>
</div>

<div id="app" class="hidden">

<div class="card">
<h2>Eventi</h2>
<input id="newEventName" placeholder="Nome evento">
<select id="eventType">
<option>Abbigliamento</option>
<option>Gadget</option>
<option>Bus</option>
</select>
<input id="eventPrice" type="number" placeholder="Prezzo €">
<button class="primary" onclick="createEvent()">Nuovo Evento</button>
<div id="eventList"></div>
</div>

<div id="eventSection" class="hidden">

<div class="card">
<h2 id="eventTitle"></h2>
<input id="customerName" placeholder="Nome">

<div id="sizesSection"></div>

<label>Pagato</label>
<input type="checkbox" id="paidCheck">

<br><br>
<button class="primary" onclick="saveOrder()">Salva</button>
<button class="gray" onclick="cancelEdit()">Annulla</button>
</div>

<div class="card">
<h2>Ordini</h2>
<div id="orders"></div>
</div>

<div class="card">
<h2>Riepilogo Ordini</h2>
<div id="summary"></div>
<button onclick="window.print()">Stampa</button>
</div>

</div>

</div>

<script>
let pin="1926";
let inputPin="";
let events=JSON.parse(localStorage.getItem("events")||"[]");
let currentEvent=null;
let editingIndex=null;

function press(n){
 if(inputPin.length<4){
   inputPin+=n;
   updateDisplay();
 }
}

function clearPin(){
 inputPin="";
 updateDisplay();
}

function updateDisplay(){
 document.getElementById("pinDisplay").innerText=
 inputPin.padEnd(4,"-");
}

function checkPin(){
 if(inputPin===pin){
   document.getElementById("pinScreen").classList.add("hidden");
   document.getElementById("app").classList.remove("hidden");
   renderEvents();
 }
 else alert("PIN errato");
}

function createEvent(){
 let name=document.getElementById("newEventName").value;
 let type=document.getElementById("eventType").value;
 let price=parseFloat(document.getElementById("eventPrice").value);
 if(!name||!price)return;
 events.push({name,type,price,orders:[]});
 save();
 renderEvents();
}

function renderEvents(){
 let list=document.getElementById("eventList");
 list.innerHTML="";
 events.forEach((e,i)=>{
   list.innerHTML+=`
   <div class="row">
   <span onclick="openEvent(${i})">${e.name}</span>
   <button class="red" onclick="deleteEvent(${i})">X</button>
   </div>`;
 });
}

function deleteEvent(i){
 if(confirm("Eliminare evento?")){
   events.splice(i,1);
   save();
   renderEvents();
 }
}

function openEvent(i){
 currentEvent=i;
 document.getElementById("eventSection").classList.remove("hidden");
 document.getElementById("eventTitle").innerText=events[i].name+" - €"+events[i].price;
 renderSizes();
 renderOrders();
}

function renderSizes(){
 let section=document.getElementById("sizesSection");
 section.innerHTML="";
 let type=events[currentEvent].type;

 if(type==="Abbigliamento"){
   ["XS","S","M","L","XL","XXL"].forEach(s=>{
     section.innerHTML+=`
     <div class="row">
     <span>${s}</span>
     <select id="size_${s}">
     ${[...Array(11).keys()].map(n=>`<option>${n}</option>`).join("")}
     </select>
     </div>`;
   });
 }
 else if(type==="Gadget"){
   section.innerHTML+=`
   <div class="row">
   <span>Quantità</span>
   <select id="size_Q">
   ${[...Array(21).keys()].map(n=>`<option>${n}</option>`).join("")}
   </select>
   </div>`;
 }
 else if(type==="Bus"){
   section.innerHTML+=`
   <div class="row">
   <span>Posti</span>
   <select id="size_Q">
   ${[...Array(51).keys()].map(n=>`<option>${n}</option>`).join("")}
   </select>
   </div>
   <div class="bus-counter" id="busCounter"></div>`;
 }
}

function saveOrder(){
 let name=document.getElementById("customerName").value;
 if(!name)return;

 let type=events[currentEvent].type;
 let data={name,paid:document.getElementById("paidCheck").checked,sizes:{}};
 let total=0;

 if(type==="Abbigliamento"){
   ["XS","S","M","L","XL","XXL"].forEach(s=>{
     let q=parseInt(document.getElementById("size_"+s).value);
     if(q>0){data.sizes[s]=q; total+=q;}
   });
 }
 else{
   let q=parseInt(document.getElementById("size_Q").value);
   if(q>0){data.sizes["Q"]=q; total+=q;}
 }

 data.total=total*events[currentEvent].price;

 if(editingIndex!==null){
   events[currentEvent].orders[editingIndex]=data;
   editingIndex=null;
 }
 else events[currentEvent].orders.push(data);

 save();
 renderOrders();
 renderSummary();
 document.getElementById("customerName").value="";
 document.getElementById("paidCheck").checked=false;
 renderSizes();
}

function renderOrders(){
 let container=document.getElementById("orders");
 container.innerHTML="";
 events[currentEvent].orders.forEach((o,i)=>{
   container.innerHTML+=`
   <div class="order-line">
   <div><strong>${o.name}</strong></div>
   <div>${formatSizes(o)} &nbsp; € ${o.total}
   <span class="status ${o.paid?'paid':'unpaid'}">
   ${o.paid?'PAGATO':'NON PAGATO'}
   </span>
   </div>
   <button onclick="editOrder(${i})">Modifica</button>
   <button class="red" onclick="deleteOrder(${i})">Elimina</button>
   </div>`;
 });
}

function editOrder(i){
 editingIndex=i;
 let o=events[currentEvent].orders[i];
 document.getElementById("customerName").value=o.name;
 document.getElementById("paidCheck").checked=o.paid;
 renderSizes();
 for(let s in o.sizes){
   let el=document.getElementById("size_"+s);
   if(el) el.value=o.sizes[s];
 }
 window.scrollTo({top:0,behavior:'smooth'});
}

function deleteOrder(i){
 events[currentEvent].orders.splice(i,1);
 save();
 renderOrders();
 renderSummary();
}

function renderSummary(){
 let s=document.getElementById("summary");
 let list=[...events[currentEvent].orders].sort((a,b)=>a.name.localeCompare(b.name));
 s.innerHTML="";
 list.forEach(o=>{
   s.innerHTML+=`
   <div class="order-line">
   <strong>${o.name}</strong><br>
   ${formatSizes(o)} &nbsp; € ${o.total}
   <span class="${o.paid?'paid':'unpaid'}">
   ${o.paid?'PAGATO':'NON PAGATO'}
   </span>
   </div>`;
 });
}

function formatSizes(o){
 return Object.entries(o.sizes)
 .map(([k,v])=>`${v} ${k}`)
 .join(" - ");
}

function cancelEdit(){
 editingIndex=null;
 document.getElementById("customerName").value="";
 renderSizes();
}

function save(){
 localStorage.setItem("events",JSON.stringify(events));
}

if("serviceWorker" in navigator){
 navigator.serviceWorker.register("sw.js");
}
</script>

</body>
</html>
