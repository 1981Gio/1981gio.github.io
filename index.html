<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GiOrders Pro</title>

<style>
body{
    margin:0;
    font-family:-apple-system,BlinkMacSystemFont,sans-serif;
    background:#f2f2f7;
    color:#111;
}
.dark{ background:#111; color:white; }
.card{
    background:white;
    margin:20px;
    padding:24px;
    border-radius:22px;
    box-shadow:0 10px 30px rgba(0,0,0,0.06);
}
.dark .card{ background:#1c1c1e; }
h2{text-align:center;margin-top:0;}
input,select{
    width:100%;
    padding:12px;
    border-radius:14px;
    border:1px solid #ddd;
    margin-bottom:12px;
}
button{
    padding:12px 16px;
    border:none;
    border-radius:14px;
    font-weight:600;
    cursor:pointer;
}
.primary{background:#007aff;color:white;}
.gray{background:#d1d1d6;}
.danger{background:#ff3b30;color:white;}
.hidden{display:none;}
#pinScreen{
    position:fixed;
    inset:0;
    background:linear-gradient(160deg,#007aff,#005edb);
    display:flex;
    flex-direction:column;
    justify-content:center;
    align-items:center;
    color:white;
}
.pin-dots{font-size:32px;letter-spacing:12px;margin:20px 0;}
.keypad{display:grid;grid-template-columns:repeat(3,90px);gap:20px;}
.keypad button{
    padding:24px;
    font-size:20px;
    border-radius:24px;
    background:rgba(255,255,255,0.2);
    color:white;
}
.order-box{
    padding:12px 0;
    border-bottom:1px solid #eee;
}
.order-box.editing{
    background:#eef5ff;
    border-radius:14px;
    padding:14px;
}
.order-name{font-weight:700;cursor:pointer;}
.switch{
    position:relative;
    display:inline-block;
    width:50px;
    height:28px;
}
.switch input{display:none;}
.slider{
    position:absolute;
    inset:0;
    background:#ccc;
    border-radius:34px;
}
.slider:before{
    content:"";
    position:absolute;
    height:22px;
    width:22px;
    left:3px;
    top:3px;
    background:white;
    border-radius:50%;
    transition:.3s;
}
input:checked + .slider{background:#34c759;}
input:checked + .slider:before{transform:translateX(22px);}
.progress-bar{
    height:14px;
    background:#e5e5ea;
    border-radius:12px;
    overflow:hidden;
    margin-top:10px;
}
.progress-fill{
    height:100%;
    background:#34c759;
}
@media print{button{display:none;}}
</style>
</head>
<body>

<div id="pinScreen">
    <h2>GiOrders Pro</h2>
    <div id="pinDots" class="pin-dots">â—‹ â—‹ â—‹ â—‹</div>
    <div class="keypad">
        <button onclick="pressPin(1)">1</button>
        <button onclick="pressPin(2)">2</button>
        <button onclick="pressPin(3)">3</button>
        <button onclick="pressPin(4)">4</button>
        <button onclick="pressPin(5)">5</button>
        <button onclick="pressPin(6)">6</button>
        <button onclick="pressPin(7)">7</button>
        <button onclick="pressPin(8)">8</button>
        <button onclick="pressPin(9)">9</button>
        <button onclick="clearPin()">C</button>
        <button onclick="pressPin(0)">0</button>
        <button onclick="checkPin()">OK</button>
    </div>
</div>

<div id="app" class="hidden"></div>

<script>

/* DATA */
let data = JSON.parse(localStorage.getItem("giorders_pro_final")) || {
    settings:{ pin:"1926", dark:false },
    events:[]
};

let currentEvent=null;
let editIndex=null;
let tempPin="";

function save(){
    localStorage.setItem("giorders_pro_final",JSON.stringify(data));
}

/* PIN */
function updateDots(){
    let dots="";
    for(let i=0;i<4;i++){
        dots+=i<tempPin.length?"â— ":"â—‹ ";
    }
    document.getElementById("pinDots").innerText=dots.trim();
}
function pressPin(n){
    if(tempPin.length<4){
        tempPin+=n;
        updateDots();
    }
}
function clearPin(){
    tempPin="";
    updateDots();
}
function checkPin(){
    if(tempPin===data.settings.pin){
        document.getElementById("pinScreen").style.display="none";
        document.getElementById("app").classList.remove("hidden");
        renderHome();
    }else{
        clearPin();
    }
}

/* HOME */
function renderHome(){
    document.body.classList.toggle("dark",data.settings.dark);
    document.getElementById("app").innerHTML=`
    <div class="card">
        <h2>Nuovo Evento</h2>
        <input id="evName" placeholder="Nome evento">
        <select id="evType">
            <option>Abbigliamento</option>
            <option>Gadget</option>
            <option>Bus</option>
        </select>
        <input id="evPrice" type="number" placeholder="Prezzo â‚¬">
        <input id="evSeats" type="number" placeholder="Posti Bus">
        <button class="primary" onclick="addEvent()">Crea Evento</button>
        <button class="gray" onclick="toggleDark()">ðŸŒ™ ModalitÃ  Scura</button>
    </div>

    <div class="card">
        <h2>Eventi</h2>
        ${
            data.events.length===0
            ? "<p>Nessun evento</p>"
            : data.events.map((e,i)=>`
                <div class="order-box">
                    <b>${e.name}</b>
                    <div style="margin-top:8px;">
                        <button class="primary" onclick="openEvent(${i})">Apri</button>
                        <button class="danger" onclick="deleteEvent(${i})">Elimina</button>
                    </div>
                </div>
            `).join("")
        }
    </div>
    `;
}

function addEvent(){
    let name=document.getElementById("evName").value.trim();
    if(!name)return;
    data.events.push({
        name,
        type:document.getElementById("evType").value,
        price:parseFloat(document.getElementById("evPrice").value)||0,
        seats:parseInt(document.getElementById("evSeats").value)||0,
        orders:[]
    });
    save();
    renderHome();
}
function deleteEvent(i){
    if(confirm("Eliminare evento?")){
        data.events.splice(i,1);
        save();
        renderHome();
    }
}
function openEvent(i){
    currentEvent=i;
    editIndex=null;
    renderEvent();
}
function toggleDark(){
    data.settings.dark=!data.settings.dark;
    save();
    renderHome();
}

/* EVENT PAGE */
function renderEvent(){
    let ev=data.events[currentEvent];
    document.getElementById("app").innerHTML=`
    <div class="card">
        <h2>${ev.name} - â‚¬${ev.price}</h2>
        ${editIndex!==null?`<div style="background:#fff3cd;padding:10px;border-radius:12px;text-align:center;">Modifica in corso</div>`:""}
        <input id="clientName" placeholder="Nome">
        ${ev.type==="Abbigliamento"?renderSizes():`<input id="quantity" type="number" placeholder="QuantitÃ ">`}
        <div style="display:flex;justify-content:center;gap:15px;margin:15px 0;">
            NON PAGATO
            <label class="switch">
                <input type="checkbox" id="paidSwitch">
                <span class="slider"></span>
            </label>
            PAGATO
        </div>
        <button class="primary" onclick="saveOrder()">${editIndex!==null?"Aggiorna":"Salva"}</button>
        <button class="gray" onclick="cancelEdit()">Annulla</button>
        <button class="gray" onclick="renderHome()">Indietro</button>
    </div>

    <div class="card">
        <h2>Ordini</h2>
        ${renderOrders()}
    </div>

    ${renderStatistics()}
    ${ev.type==="Abbigliamento"?renderEmissione():""}
    ${ev.type==="Bus"?renderBusBar():""}
    `;
}

/* SIZES */
function renderSizes(){
    let sizes=["XS","S","M","L","XL","XXL","XXXL"];
    return sizes.map(s=>`
        <div style="display:flex;justify-content:space-between;margin-bottom:10px;">
            <div>${s}</div>
            <select id="size_${s}">
                ${Array.from({length:21},(_,i)=>`<option>${i}</option>`).join("")}
            </select>
        </div>
    `).join("");
}

/* SAVE ORDER */
function saveOrder(){
    let ev=data.events[currentEvent];
    let name=document.getElementById("clientName").value.trim();
    if(!name)return;
    let order={name,paid:document.getElementById("paidSwitch").checked};

    if(ev.type==="Abbigliamento"){
        order.sizes={};
        let totalQty=0;
        ["XS","S","M","L","XL","XXL","XXXL"].forEach(s=>{
            let q=parseInt(document.getElementById("size_"+s).value);
            if(q>0){order.sizes[s]=q;totalQty+=q;}
        });
        if(totalQty===0)return;
        order.total=totalQty*ev.price;
    }else{
        let q=parseInt(document.getElementById("quantity").value)||0;
        if(q===0)return;
        order.qty=q;
        order.total=q*ev.price;
    }

    if(editIndex!==null){
        ev.orders[editIndex]=order;
        editIndex=null;
    }else{
        ev.orders.push(order);
    }

    save();
    renderEvent();
}

/* ORDERS SORTED */
function renderOrders(){
    let ev=data.events[currentEvent];
    if(ev.orders.length===0)return "<p>Nessun ordine</p>";

    let sorted=[...ev.orders].sort((a,b)=>a.name.localeCompare(b.name,"it"));

    return sorted.map(o=>{
        let i=ev.orders.indexOf(o);
        return `
        <div class="order-box ${editIndex===i?'editing':''}">
            <div class="order-name" onclick="editOrder(${i})">${o.name}</div>
            <div style="display:flex;justify-content:space-between;">
                <div>${
                    ev.type==="Abbigliamento"
                    ? Object.entries(o.sizes).map(([k,v])=>`${v} ${k}`).join(" - ")
                    : o.qty+" pezzi"
                }</div>
                <div><b>â‚¬ ${o.total}</b></div>
            </div>
            <div style="margin-top:8px;">
                <button onclick="editOrder(${i})">Modifica</button>
                <button class="danger" onclick="deleteOrder(${i})">Elimina</button>
            </div>
        </div>
        `;
    }).join("");
}

/* EDIT */
function editOrder(i){
    editIndex=i;
    renderEvent();
    setTimeout(()=>{
        let o=data.events[currentEvent].orders[i];
        document.getElementById("clientName").value=o.name;
        document.getElementById("paidSwitch").checked=o.paid;
        if(o.sizes){
            Object.entries(o.sizes).forEach(([k,v])=>{
                document.getElementById("size_"+k).value=v;
            });
        }
        if(o.qty){
            document.getElementById("quantity").value=o.qty;
        }
        window.scrollTo({top:0,behavior:"smooth"});
    },50);
}

function cancelEdit(){
    editIndex=null;
    renderEvent();
}
function deleteOrder(i){
    if(confirm("Eliminare ordine?")){
        data.events[currentEvent].orders.splice(i,1);
        save();
        renderEvent();
    }
}

/* STATS */
function renderStatistics(){
    let ev=data.events[currentEvent];
    let totale=0,pezzi=0;
    ev.orders.forEach(o=>{
        totale+=o.total;
        if(o.sizes) pezzi+=Object.values(o.sizes).reduce((a,b)=>a+b,0);
        if(o.qty) pezzi+=o.qty;
    });
    return `
    <div class="card">
        <h2>Riepilogo Evento</h2>
        <div>Totale pezzi: <b>${pezzi}</b></div>
        <div>Incasso totale: <b>â‚¬ ${totale}</b></div>
    </div>`;
}

/* EMISSIONE */
function renderEmissione(){
    let ev=data.events[currentEvent];
    let totals={XS:0,S:0,M:0,L:0,XL:0,XXL:0,XXXL:0};
    ev.orders.forEach(o=>{
        if(o.sizes){
            Object.keys(totals).forEach(s=>{
                totals[s]+=o.sizes[s]||0;
            });
        }
    });
    let rows=Object.entries(totals)
        .filter(([k,v])=>v>0)
        .map(([k,v])=>`<div>${k}: <b>${v}</b></div>`)
        .join("");
    if(!rows)return "";
    return `
    <div class="card">
        <h2>Emissione Ordine</h2>
        ${rows}
        <button onclick="window.print()">Stampa</button>
    </div>`;
}

/* BUS */
function renderBusBar(){
    let ev=data.events[currentEvent];
    let booked=ev.orders.reduce((a,b)=>a+(b.qty||0),0);
    let percent=ev.seats?(booked/ev.seats)*100:0;
    return `
    <div class="card">
        <h2>Posti Bus</h2>
        <div>${booked}/${ev.seats}</div>
        <div class="progress-bar">
            <div class="progress-fill" style="width:${percent}%"></div>
        </div>
    </div>`;
}

updateDots();

</script>
</body>
</html>