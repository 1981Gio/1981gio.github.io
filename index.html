<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GiOrders Pro v4.1</title>
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-192.PNG">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="theme-color" content="#0a84ff">

<style>

body{
    margin:0;
    font-family:-apple-system,BlinkMacSystemFont,sans-serif;
    background:#f2f2f7;
    color:#111;
}

.dark{
    background:#000;
    color:#fff;
}

.container{
    max-width:600px;
    margin:auto;
    padding:20px;
}

.card{
    background:white;
    border-radius:20px;
    padding:16px 18px;
    margin-bottom:20px;
    box-shadow:0 10px 30px rgba(0,0,0,0.05);
}

.dark .card{
    background:#1c1c1e;
}

input{
    width:90%;
    margin:0 auto;
    display:block;
    padding:14px 16px;
    border-radius:16px;
    border:1px solid #e5e5ea;
    font-size:15px;
    margin-bottom:14px;
    background:white;
}

select{
  width:70px;
  margin-left:10px;
  padding:6px 8px;
  border-radius:10px;
  border:1px solid #e0e0e5;
  font-size:14px;
  background:white;
}

button{
    border:none;
    border-radius:14px;
    padding:10px 16px;
    font-weight:600;
    cursor:pointer;
}

.primary{background:#0a84ff;color:white;}
.secondary{background:#e5e5ea;}
.dark .secondary{background:#2c2c2e;color:white;}
.danger{background:#ff3b30;color:white;}

.hidden{display:none;}

/* PIN */
#pinScreen{
    position:fixed;
    inset:0;
    background:linear-gradient(180deg,#0a84ff,#0066ff);
    display:flex;
    flex-direction:column;
    justify-content:center;
    align-items:center;
    color:white;
}

.pin-dots{
    font-size:34px;
    letter-spacing:14px;
    margin:25px 0;
}

.keypad{
    display:grid;
    grid-template-columns:repeat(3,85px);
    gap:18px;
}

.keypad button{
    height:70px;
    width:70px;
    border-radius:50%;
    background:rgba(255,255,255,0.18);
    color:white;
    font-size:20px;
}

/* Switch iOS */
.switch{
    position:relative;
    display:inline-block;
    width:52px;
    height:30px;
}

.switch input{display:none;}

.slider{
    position:absolute;
    inset:0;
    background:#e5e5ea;
    border-radius:30px;
    transition:.3s;
}

.slider:before{
    content:"";
    position:absolute;
    height:26px;
    width:26px;
    left:2px;
    top:2px;
    background:white;
    border-radius:50%;
    transition:.3s;
}

.switch input:checked + .slider{
    background:#34c759;
}

.switch input:checked + .slider:before{
    transform:translateX(22px);
}

.size-row{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:10px;
}

.size-row select{
    width:70px;
}

.order-box{
    padding:12px 0;
    border-bottom:1px solid #eee;
}

.order-box.editing{
    background:#e8f0ff;
    border-radius:14px;
    padding:12px;
}

.progress-bar{
    height:14px;
    background:#e5e5ea;
    border-radius:12px;
    overflow:hidden;
    margin-top:10px;
}

.progress-fill{
    height:100%;
    background:#34c759;
}

</style>
</head>
<body>

<div id="pinScreen">
    <h1>GiOrders Pro</h1>
    <div id="pinDots" class="pin-dots">‚óã ‚óã ‚óã ‚óã</div>
    <div class="keypad">
        <button onclick="pressPin(1)">1</button>
        <button onclick="pressPin(2)">2</button>
        <button onclick="pressPin(3)">3</button>
        <button onclick="pressPin(4)">4</button>
        <button onclick="pressPin(5)">5</button>
        <button onclick="pressPin(6)">6</button>
        <button onclick="pressPin(7)">7</button>
        <button onclick="pressPin(8)">8</button>
        <button onclick="pressPin(9)">9</button>
        <button onclick="clearPin()">C</button>
        <button onclick="pressPin(0)">0</button>
        <button onclick="checkPin()">OK</button>
    </div>
</div>

<div id="app" class="hidden container"></div>

<script>
/* =============================
   CORE DATA
============================= */

let data = JSON.parse(localStorage.getItem("giorders_pro_v41")) || {
    settings:{
        pin:"1926",
        dark:false
    },
    events:[]
};

let currentEvent = null;
let editIndex = null;
let tempPin = "";

/* =============================
   SAVE
============================= */

function save(){
    localStorage.setItem("giorders_pro_v41", JSON.stringify(data));
}

/* =============================
   PIN SYSTEM
============================= */

function updateDots(){
    let dots="";
    for(let i=0;i<4;i++){
        dots += i < tempPin.length ? "‚óè " : "‚óã ";
    }
    document.getElementById("pinDots").innerText = dots.trim();
}

function pressPin(n){
    if(tempPin.length < 4){
        tempPin += n;
        updateDots();
    }
}

function clearPin(){
    tempPin="";
    updateDots();
}

function checkPin(){
    if(tempPin === data.settings.pin){
        document.getElementById("pinScreen").style.display="none";
        document.getElementById("app").classList.remove("hidden");
        renderHome();
    }else{
        clearPin();
        alert("PIN errato");
    }
}

/* =============================
   CAMBIO PIN SICURO
============================= */

function changePin(){
    let oldPin = prompt("Inserisci PIN attuale:");
    if(oldPin !== data.settings.pin){
        alert("PIN errato");
        return;
    }

    let newPin = prompt("Nuovo PIN (4 cifre):");
    if(!newPin || newPin.length !==4){
        alert("PIN non valido");
        return;
    }

    data.settings.pin = newPin;
    save();
    alert("PIN aggiornato");
}
/* =============================
   HOME
============================= */

function renderHome(){

    document.body.classList.toggle("dark", data.settings.dark);

    document.getElementById("app").innerHTML = `
    
        <div class="card">
            <h2>Nuovo Evento</h2>

            <input id="evName" placeholder="Nome evento">

            <select id="evType">
                <option value="Abbigliamento">Abbigliamento</option>
                <option value="Gadget">Gadget</option>
                <option value="Bus">Bus</option>
            </select>

            <input id="evPrice" type="number" placeholder="Prezzo ‚Ç¨">
            <input id="evSeats" type="number" placeholder="Posti Bus (solo Bus)">

            <button class="primary" onclick="addEvent()">Crea Evento</button>
        </div>

        <div class="card">
            <h2>Eventi</h2>

            ${
                data.events.length === 0
                ? "<p style='text-align:center;opacity:.6;'>Nessun evento creato</p>"
                : data.events.map((e,i)=>`
                    <div class="order-box">
                        <div style="display:flex;justify-content:space-between;align-items:center;">
                            <div>
                                <div style="font-weight:700;">${e.name}</div>
                                <div style="font-size:12px;opacity:.6;">${e.type}</div>
                            </div>
                            <div>‚Ç¨ ${e.price}</div>
                        </div>

                        <div style="margin-top:10px;display:flex;gap:8px;">
                            <button class="secondary" onclick="openEvent(${i})">Apri</button>
                            <button class="danger" onclick="deleteEvent(${i})">Elimina</button>
                        </div>
                    </div>
                `).join("")
            }
        </div>

        <div class="card">
            <h2>Impostazioni</h2>

            <div style="display:grid;gap:10px;">
                <button class="secondary" onclick="toggleDark()">üåô Modalit√† Giorno/Notte</button>
                <button class="secondary" onclick="changePin()">üîê Cambia PIN</button>
                <button class="secondary" onclick="exportBackup()">üíæ Backup</button>
                <input type="file" onchange="importBackup(event)">
            </div>
        </div>
    `;
}

/* =============================
   EVENTI
============================= */

function addEvent(){
    let name = document.getElementById("evName").value.trim();
    let type = document.getElementById("evType").value;
    let price = parseFloat(document.getElementById("evPrice").value) || 0;
    let seats = parseInt(document.getElementById("evSeats").value) || 0;

    if(!name){
        alert("Inserisci nome evento");
        return;
    }

    data.events.push({
        name,
        type,
        price,
        seats,
        orders:[]
    });

    save();
    renderHome();
}

function deleteEvent(i){
    if(confirm("Eliminare evento?")){
        data.events.splice(i,1);
        save();
        renderHome();
    }
}

function openEvent(i){
    currentEvent = i;
    editIndex = null;
    renderEvent();
}
/* =============================
   PAGINA EVENTO
============================= */

function renderEvent(){

    let ev = data.events[currentEvent];

    document.getElementById("app").innerHTML = `
        <div class="card">
            <h2>${ev.name} - ‚Ç¨${ev.price}</h2>

            ${editIndex !== null ? `
                <div style="
                    background:#e8f0ff;
                    padding:10px;
                    border-radius:12px;
                    margin-bottom:12px;
                    text-align:center;
                    font-weight:600;">
                    ‚úèÔ∏è Modifica ordine
                </div>
            ` : ""}

            <input id="clientName" placeholder="Nome cliente">

            ${ev.type === "Abbigliamento" ? renderSizes() : `
                <input id="quantity" type="number" placeholder="Quantit√†">
            `}

            <div style="
                display:flex;
                justify-content:space-between;
                align-items:center;
                margin:15px 0;
                padding:10px 0;
                border-top:1px solid #eee;
                border-bottom:1px solid #eee;
            ">

                <div style="font-weight:500;">
                    Stato pagamento
                </div>

                <div style="display:flex;align-items:center;gap:10px;">
                    <span style="font-size:13px;color:#ff3b30;">
                        NON PAGATO
                    </span>

                    <label class="switch">
                        <input type="checkbox" id="paidSwitch">
                        <span class="slider"></span>
                    </label>

                    <span style="font-size:13px;color:#34c759;">
                        PAGATO
                    </span>
                </div>

            </div>

            <div style="display:flex;gap:8px;">
                <button class="primary" onclick="saveOrder()">
                    ${editIndex !== null ? "Aggiorna" : "Salva"}
                </button>
                <button class="secondary" onclick="cancelEdit()">Annulla</button>
                <button class="secondary" onclick="renderHome()">Indietro</button>
            </div>
        </div>

        <div class="card">
            <h2>Ordini</h2>
            ${renderOrders()}
        </div>

        ${renderStatistics()}
        ${ev.type==="Abbigliamento" ? renderEmissione() : ""}
        ${ev.type==="Bus" ? renderBusBar() : ""}
    `;

    window.scrollTo({top:0,behavior:"smooth"});
}

/* =============================
   TAGLIE
============================= */

function renderSizes(){
    let sizes=["XS","S","M","L","XL","XXL","XXXL"];
    return sizes.map(s=>`
        <div class="size-row">
            <div>${s}</div>
            <select id="size_${s}">
                ${[0,1,2,3,4,5,6,7,8,9,10].map(n=>`<option value="${n}">${n}</option>`).join("")}
            </select>
        </div>
    `).join("");
}
/* =============================
   SALVA / AGGIORNA ORDINE
============================= */

function saveOrder(){

    let ev = data.events[currentEvent];
    let name = document.getElementById("clientName").value.trim();

    if(!name){
        alert("Inserisci nome cliente");
        return;
    }

    let order = {
        name,
        paid: document.getElementById("paidSwitch").checked
    };

    if(ev.type === "Abbigliamento"){

        order.sizes = {};
        let totalQty = 0;

        ["XS","S","M","L","XL","XXL","XXXL"].forEach(s=>{
            let q = parseInt(document.getElementById("size_"+s).value);
            if(q > 0){
                order.sizes[s] = q;
                totalQty += q;
            }
        });

        if(totalQty === 0){
            alert("Inserisci almeno una quantit√†");
            return;
        }

        order.total = totalQty * ev.price;

    }else{

        let q = parseInt(document.getElementById("quantity").value) || 0;

        if(q === 0){
            alert("Inserisci quantit√†");
            return;
        }

        if(ev.type === "Bus"){
            let booked = ev.orders.reduce((a,b)=>a+(b.qty||0),0);

            if(editIndex === null && booked + q > ev.seats){
                alert("Posti insufficienti");
                return;
            }
        }

        order.qty = q;
        order.total = q * ev.price;
    }

    if(editIndex !== null){
        ev.orders[editIndex] = order;
        editIndex = null;
    }else{
        ev.orders.push(order);
    }

    save();
    renderEvent();
}

/* =============================
   ORDINI ORDINATI ALFABETICAMENTE
============================= */

function renderOrders(){

    let ev = data.events[currentEvent];

    if(ev.orders.length === 0){
        return "<p style='opacity:.6;'>Nessun ordine inserito</p>";
    }

    let sorted = [...ev.orders].sort((a,b)=>
        a.name.localeCompare(b.name,"it")
    );

    return sorted.map(o=>{

        let i = ev.orders.indexOf(o);

        return `
        <div class="order-box ${editIndex===i?'editing':''}">

            <div style="font-weight:700;cursor:pointer;"
                 onclick="editOrder(${i})">
                ${o.name}
            </div>

            <div style="display:flex;justify-content:space-between;margin-top:6px;">
                <div>
                    ${
                        ev.type==="Abbigliamento"
                        ? Object.entries(o.sizes)
                            .map(([k,v])=>`${v} ${k}`)
                            .join(" - ")
                        : o.qty+" pezzi"
                    }
                </div>
                <div style="text-align:right;">
                    <div><b>‚Ç¨ ${o.total}</b></div>
                    <div style="
                        font-size:13px;
                        font-weight:600;
                        color:${o.paid ? '#34c759' : '#ff3b30'};
                    ">
                        ${o.paid ? 'PAGATO' : 'NON PAGATO'}
                    </div>
                </div>
            </div>

            <div style="margin-top:8px;display:flex;gap:8px;">
                <button class="secondary" onclick="editOrder(${i})">
                    Modifica
                </button>
                <button class="danger" onclick="deleteOrder(${i})">
                    Elimina
                </button>
            </div>

        </div>
        `;

    }).join("");
}

/* =============================
   MODIFICA ORDINE (FLUIDA)
============================= */

function editOrder(i){

    editIndex = i;
    renderEvent();

    setTimeout(()=>{

        let o = data.events[currentEvent].orders[i];

        document.getElementById("clientName").value = o.name;
        document.getElementById("paidSwitch").checked = o.paid;

        if(o.sizes){
            Object.entries(o.sizes).forEach(([k,v])=>{
                let el = document.getElementById("size_"+k);
                if(el) el.value = v;
            });
        }

        if(o.qty){
            let q = document.getElementById("quantity");
            if(q) q.value = o.qty;
        }

        window.scrollTo({top:0,behavior:"smooth"});

    },100);
}

function deleteOrder(i){
    if(confirm("Eliminare ordine?")){
        data.events[currentEvent].orders.splice(i,1);
        save();
        renderEvent();
    }
}

function cancelEdit(){
    editIndex = null;
    renderEvent();
}
/* =============================
   STATISTICHE EVENTO
============================= */

function renderStatistics(){

    let ev = data.events[currentEvent];

    let totale = 0;
    let pezzi = 0;
    let incassato = 0;

    ev.orders.forEach(o=>{
        totale += o.total;

        if(o.paid){
            incassato += o.total;
        }

        if(o.sizes){
            pezzi += Object.values(o.sizes)
                .reduce((a,b)=>a+b,0);
        }

        if(o.qty){
            pezzi += o.qty;
        }
    });

    return `
        <div class="card">
            <h2>Riepilogo Evento</h2>
            <div>Totale pezzi: <b>${pezzi}</b></div>
            <div>Incasso totale: <b>‚Ç¨ ${totale}</b></div>
            <div>Incassato: <b style="color:#34c759;">‚Ç¨ ${incassato}</b></div>
            <div>Da incassare: <b style="color:#ff3b30;">‚Ç¨ ${totale - incassato}</b></div>
        </div>
    `;
}

/* =============================
   EMISSIONE ORDINE (ABBIGLIAMENTO)
============================= */

function renderEmissione(){

    let ev = data.events[currentEvent];

    let totals = {
        XS:0,S:0,M:0,L:0,XL:0,XXL:0,XXXL:0
    };

    ev.orders.forEach(o=>{
        if(o.sizes){
            Object.keys(totals).forEach(size=>{
                totals[size] += o.sizes[size] || 0;
            });
        }
    });

    let rows = Object.entries(totals)
        .filter(([k,v])=>v>0)
        .map(([k,v])=>`<div>${k}: <b>${v}</b></div>`)
        .join("");

    if(!rows) return "";

    return `
        <div class="card">
            <h2>Emissione Ordine</h2>
            ${rows}
            <button class="secondary"
                onclick="window.print()">
                Stampa
            </button>
        </div>
    `;
}

/* =============================
   BUS PROGRESS BAR
============================= */

function renderBusBar(){

    let ev = data.events[currentEvent];

    let booked = ev.orders
        .reduce((a,b)=>a+(b.qty||0),0);

    let percent = ev.seats
        ? Math.min((booked/ev.seats)*100,100)
        : 0;

    return `
        <div class="card">
            <h2>Posti Bus</h2>
            <div>${booked} / ${ev.seats}</div>

            <div class="progress-bar">
                <div class="progress-fill"
                     style="width:${percent}%">
                </div>
            </div>
        </div>
    `;
}

/* =============================
   DARK MODE
============================= */

function toggleDark(){
    data.settings.dark = !data.settings.dark;
    save();
    renderHome();
}

/* =============================
   BACKUP / RIPRISTINO
============================= */

function exportBackup(){

    let blob = new Blob(
        [JSON.stringify(data,null,2)],
        {type:"application/json"}
    );

    let a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "giorders_backup.json";
    a.click();
}

function importBackup(e){

    if(!e.target.files[0]) return;

    let reader = new FileReader();

    reader.onload = function(){
        try{
            data = JSON.parse(reader.result);
            save();
            renderHome();
            alert("Backup ripristinato");
        }catch{
            alert("File non valido");
        }
    };

    reader.readAsText(e.target.files[0]);
}

/* =============================
   INIT APP
============================= */

updateDots();

</script>
</body>
</html>