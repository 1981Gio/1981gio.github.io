<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GiOrders Pro</title>
<meta name="theme-color" content="#007aff">
<style>

body{
    margin:0;
    font-family:-apple-system,BlinkMacSystemFont,sans-serif;
    background:#f2f2f7;
    color:#111;
}

.dark{
    background:#111;
    color:white;
}

.card{
    background:white;
    margin:20px;
    padding:22px;
    border-radius:22px;
    box-shadow:0 8px 25px rgba(0,0,0,0.06);
}

.dark .card{
    background:#1c1c1e;
}

h2{
    text-align:center;
    margin-top:0;
}

input, select{
    width:100%;
    padding:10px;
    border-radius:12px;
    border:1px solid #ddd;
    margin-bottom:12px;
    font-size:14px;
}

.size-row{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:8px;
}

.size-row select{
    width:70px;
    padding:6px;
    border-radius:10px;
    font-size:13px;
}

button{
    padding:10px 14px;
    border:none;
    border-radius:14px;
    font-weight:600;
    cursor:pointer;
}

.primary{background:#007aff;color:white;}
.gray{background:#d1d1d6;}
.danger{background:#ff3b30;color:white;}

.order-box{
    padding:12px 0;
    border-bottom:1px solid #eee;
}

.order-box.editing{
    background:#e8f2ff;
    border-radius:14px;
    padding:12px;
}

.badge-paid{color:#34c759;font-weight:700;}
.badge-unpaid{color:#ff3b30;font-weight:700;}

.hidden{display:none;}

.paid-container{
    display:flex;
    justify-content:center;
    align-items:center;
    gap:12px;
    margin:10px 0;
}

.progress-bar{
    height:12px;
    background:#e5e5ea;
    border-radius:10px;
    overflow:hidden;
}

.progress-fill{
    height:100%;
    background:#34c759;
}

</style>
</head>
<body>

<div id="pinScreen">
    <div class="card" style="text-align:center">
        <h2>GiOrders Pro</h2>
        <div id="pinDots">‚óã ‚óã ‚óã ‚óã</div>

        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:20px;">
            <button onclick="pressPin(1)">1</button>
            <button onclick="pressPin(2)">2</button>
            <button onclick="pressPin(3)">3</button>
            <button onclick="pressPin(4)">4</button>
            <button onclick="pressPin(5)">5</button>
            <button onclick="pressPin(6)">6</button>
            <button onclick="pressPin(7)">7</button>
            <button onclick="pressPin(8)">8</button>
            <button onclick="pressPin(9)">9</button>
            <button onclick="clearPin()">C</button>
            <button onclick="pressPin(0)">0</button>
            <button onclick="checkPin()">OK</button>
        </div>
    </div>
</div>

<div id="app" class="hidden"></div>
<script>

let data = JSON.parse(localStorage.getItem("giorders_pro_v4")) || {
    settings:{ pin:"1926", dark:false },
    events:[]
};

let currentEvent=null;
let editIndex=null;
let tempPin="";

function save(){
    localStorage.setItem("giorders_pro_v4",JSON.stringify(data));
}

function updateDots(){
    let dots="";
    for(let i=0;i<4;i++){
        dots += i<tempPin.length ? "‚óè " : "‚óã ";
    }
    document.getElementById("pinDots").innerText=dots.trim();
}

function pressPin(n){
    if(tempPin.length<4){
        tempPin+=n;
        updateDots();
    }
}

function clearPin(){
    tempPin="";
    updateDots();
}

function checkPin(){
    if(tempPin===data.settings.pin){
        document.getElementById("pinScreen").style.display="none";
        document.getElementById("app").classList.remove("hidden");
        renderHome();
    }else{
        tempPin="";
        updateDots();
    }
}
function renderHome(){

document.body.classList.toggle("dark",data.settings.dark);

document.getElementById("app").innerHTML=`
<div class="card">
<h2>Nuovo Evento</h2>
<input id="evName" placeholder="Nome evento">
<select id="evType">
<option value="Abbigliamento">Abbigliamento</option>
<option value="Gadget">Gadget</option>
<option value="Bus">Bus</option>
</select>
<input id="evPrice" type="number" placeholder="Prezzo ‚Ç¨">
<input id="evSeats" type="number" placeholder="Posti Bus (solo Bus)">
<button class="primary" onclick="addEvent()">Crea Evento</button>
<button class="gray" onclick="toggleDark()">üåô Modalit√† Giorno/Notte</button>
<button class="gray" onclick="exportBackup()">üíæ Backup</button>
<input type="file" onchange="importBackup(event)">
</div>

<div class="card">
<h2>Eventi</h2>
${data.events.map((e,i)=>`
<div class="order-box">
<b>${e.name}</b>
<button onclick="openEvent(${i})">Apri</button>
<button class="danger" onclick="deleteEvent(${i})">Elimina</button>
</div>`).join("")}
</div>
`;
}
function openEvent(i){
currentEvent=i;
editIndex=null;
renderEvent();
}

function renderEvent(){

let ev=data.events[currentEvent];

ev.orders.sort((a,b)=>a.name.localeCompare(b.name,"it"));

document.getElementById("app").innerHTML=`
<div class="card">
<h2>${ev.name} - ‚Ç¨${ev.price}</h2>

${editIndex!==null?`<div style="color:#007aff;font-weight:600">‚úèÔ∏è Modifica ordine</div>`:""}

<input id="clientName" placeholder="Nome">

${ev.type==="Abbigliamento"?renderSizes():`<input id="quantity" type="number" placeholder="Quantit√†">`}

<div class="paid-container">
<label><input type="checkbox" id="paidSwitch"> Pagato</label>
</div>

<button class="primary" onclick="saveOrder()">${editIndex!==null?"Aggiorna":"Salva"}</button>
<button class="gray" onclick="cancelEdit()">Annulla</button>
<button class="gray" onclick="renderHome()">Indietro</button>
</div>

<div class="card">
<h2>Ordini</h2>
${renderOrders()}
</div>

${renderStatistics()}
${ev.type==="Abbigliamento"?renderEmissione():""}
${ev.type==="Bus"?renderBusBar():""}
`;
}
function saveOrder(){

let ev=data.events[currentEvent];
let name=document.getElementById("clientName").value.trim();
if(!name) return;

let order={name,paid:document.getElementById("paidSwitch").checked};

if(ev.type==="Abbigliamento"){
order.sizes={};
let total=0;
["XS","S","M","L","XL","XXL","XXXL"].forEach(s=>{
let q=parseInt(document.getElementById("size_"+s).value);
if(q>0){order.sizes[s]=q;total+=q;}
});
if(total===0)return;
order.total=total*ev.price;
}else{
let q=parseInt(document.getElementById("quantity").value)||0;
if(q===0)return;
order.qty=q;
order.total=q*ev.price;
}

if(editIndex!==null){
ev.orders[editIndex]=order;
editIndex=null;
}else{
ev.orders.push(order);
}

save();
renderEvent();
}

function renderOrders(){

let ev=data.events[currentEvent];
if(ev.orders.length===0)return "<p>Nessun ordine</p>";

return ev.orders.map((o,i)=>`
<div class="order-box ${editIndex===i?"editing":""}">
<b onclick="editOrder(${i})" style="cursor:pointer">${o.name}</b>
<div>‚Ç¨ ${o.total}</div>
<div class="${o.paid?"badge-paid":"badge-unpaid"}">${o.paid?"PAGATO":"NON PAGATO"}</div>
<button onclick="editOrder(${i})">Modifica</button>
<button class="danger" onclick="deleteOrder(${i})">Elimina</button>
</div>`).join("");
}

function editOrder(i){
editIndex=i;
renderEvent();
setTimeout(()=>{
let o=data.events[currentEvent].orders[i];
document.getElementById("clientName").value=o.name;
document.getElementById("paidSwitch").checked=o.paid;
if(o.sizes){
Object.entries(o.sizes).forEach(([k,v])=>{
document.getElementById("size_"+k).value=v;
});
}
if(o.qty){
document.getElementById("quantity").value=o.qty;
}
window.scrollTo({top:0,behavior:"smooth"});
},50);
}

function deleteOrder(i){
if(confirm("Eliminare ordine?")){
data.events[currentEvent].orders.splice(i,1);
save();
renderEvent();
}
}

function cancelEdit(){
editIndex=null;
renderEvent();
}
function renderSizes(){
return ["XS","S","M","L","XL","XXL","XXXL"].map(s=>`
<div class="size-row">
<div>${s}</div>
<select id="size_${s}">
${[0,1,2,3,4,5,6,7,8,9,10].map(n=>`<option>${n}</option>`).join("")}
</select>
</div>`).join("");
}

function renderStatistics(){
let ev=data.events[currentEvent];
let totale=0;
ev.orders.forEach(o=>totale+=o.total);
return `<div class="card"><h2>Riepilogo</h2>Incasso totale: ‚Ç¨ ${totale}</div>`;
}

function renderEmissione(){
let ev=data.events[currentEvent];
let totals={XS:0,S:0,M:0,L:0,XL:0,XXL:0,XXXL:0};
ev.orders.forEach(o=>{
if(o.sizes){
Object.keys(totals).forEach(s=>totals[s]+=o.sizes[s]||0);
}
});
return `<div class="card"><h2>Emissione</h2>
${Object.entries(totals).map(([k,v])=>v>0?`${k}: ${v}<br>`:"").join("")}
</div>`;
}

function renderBusBar(){
let ev=data.events[currentEvent];
let booked=ev.orders.reduce((a,b)=>a+(b.qty||0),0);
let percent=ev.seats?(booked/ev.seats)*100:0;
return `<div class="card"><h2>Bus</h2>
<div>${booked}/${ev.seats}</div>
<div class="progress-bar"><div class="progress-fill" style="width:${percent}%"></div></div>
</div>`;
}

function addEvent(){
let name=document.getElementById("evName").value.trim();
if(!name)return;
data.events.push({
name,
type:document.getElementById("evType").value,
price:parseFloat(document.getElementById("evPrice").value)||0,
seats:parseInt(document.getElementById("evSeats").value)||0,
orders:[]
});
save();
renderHome();
}

function deleteEvent(i){
data.events.splice(i,1);
save();
renderHome();
}

function toggleDark(){
data.settings.dark=!data.settings.dark;
save();
renderHome();
}

function exportBackup(){
let blob=new Blob([JSON.stringify(data,null,2)],{type:"application/json"});
let a=document.createElement("a");
a.href=URL.createObjectURL(blob);
a.download="giorders_backup.json";
a.click();
}

function importBackup(e){
let reader=new FileReader();
reader.onload=function(){
data=JSON.parse(reader.result);
save();
renderHome();
};
reader.readAsText(e.target.files[0]);
}

updateDots();

</script>
</body>
</html>