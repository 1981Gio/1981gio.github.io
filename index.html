<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GiOrders Pro</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0A84FF">
<meta name="apple-mobile-web-app-capable" content="yes">
<link rel="apple-touch-icon" href="1FFB8DDC-1EC1-4569-971E-598213CC5587.png">

<style>
:root{--bg:#f2f2f7;--card:#fff;--text:#000;}
.dark{--bg:#1c1c1e;--card:#2c2c2e;--text:#fff;}

body{font-family:-apple-system,sans-serif;background:var(--bg);
color:var(--text);padding:16px;}

.card{
background:var(--card);
padding:16px;
border-radius:16px;
margin-bottom:16px;
box-shadow:0 6px 18px rgba(0,0,0,0.08);
transition:all .3s ease;
}

.row{
display:flex;
justify-content:space-between;
align-items:center;
margin-bottom:14px;
padding:10px;
border-radius:12px;
transition:all .3s ease;
}

.row:hover{background:rgba(0,0,0,0.05);}
.row.editing{background:#ffe082;}

button{
padding:8px 10px;
border:none;
border-radius:10px;
font-size:13px;
margin-left:4px;
}

.primary{background:#0A84FF;color:white;}
.red{background:#ff3b30;color:white;}

input,select{
width:100%;
padding:8px;
margin-bottom:8px;
border-radius:10px;
border:1px solid #ccc;
}

.switch{position:relative;width:44px;height:24px;}
.switch input{display:none;}
.slider{
position:absolute;top:0;left:0;right:0;bottom:0;
background:#ccc;border-radius:24px;
}
.slider:before{
content:"";position:absolute;
height:18px;width:18px;
left:3px;bottom:3px;
background:white;border-radius:50%;
transition:.3s;
}
input:checked + .slider{background:#34c759;}
input:checked + .slider:before{transform:translateX(20px);}

.stat-box,.summary-box{
background:#e9f1ff;
padding:10px;
border-radius:10px;
margin-bottom:6px;
}

.pin-grid{
display:grid;
grid-template-columns:repeat(3,1fr);
gap:10px;
margin-top:15px;
}

.pin-grid button{
font-size:20px;
padding:18px;
}

@media print{
button,.switch{display:none;}
body{background:white;}
}
</style>
</head>

<body>

<div id="login"></div>
<div id="app" style="display:none;"></div>

<script>

/* ================= PIN ================= */

let savedPIN = localStorage.getItem("gi_pin") || "1926";
let pinValue="";

function renderLogin(){
login.innerHTML=`
<div class="card" style="text-align:center;">
<h2>GiOrders Pro</h2>
<div id="dots" style="font-size:28px;letter-spacing:10px;margin:20px 0;">‚óã ‚óã ‚óã ‚óã</div>
<div class="pin-grid">
${[1,2,3,4,5,6,7,8,9].map(n=>`<button onclick="digita(${n})">${n}</button>`).join("")}
<button onclick="cancella()">‚å´</button>
<button onclick="digita(0)">0</button>
<button onclick="resetPin()">Reset</button>
</div>
</div>`;
}

function digita(n){
if(pinValue.length>=4)return;
pinValue+=n;
aggiornaDots();
if(pinValue.length===4)setTimeout(controllaPIN,200);
}

function aggiornaDots(){
let out="";
for(let i=0;i<4;i++)out+=i<pinValue.length?"‚óè ":"‚óã ";
document.getElementById("dots").innerHTML=out;
}

function controllaPIN(){
if(pinValue===savedPIN){
login.style.display="none";
app.style.display="block";
renderHome();
}else{
alert("PIN errato");
pinValue="";
aggiornaDots();
}
}

function cancella(){pinValue=pinValue.slice(0,-1);aggiornaDots();}
function resetPin(){pinValue="";aggiornaDots();}
function cambiaPIN(){
let nuovo=prompt("Nuovo PIN");
if(nuovo && nuovo.length>=4){
savedPIN=nuovo;
localStorage.setItem("gi_pin",nuovo);
}
}

/* ================= CORE ================= */

let eventi=JSON.parse(localStorage.getItem("gi_eventi"))||{};
let eventoCorrente=null;
let taglie=["XS","S","M","L","XL","XXL"];
let indiceModifica=null;

function salva(){localStorage.setItem("gi_eventi",JSON.stringify(eventi));}

/* ================= HOME ================= */

function renderHome(){
app.innerHTML=`
<div class="card">
<button onclick="toggleDark()">üåô</button>
<button onclick="cambiaPIN()">üîê</button>
<button onclick="esportaBackup()">üíæ</button>
<button onclick="importaBackup()">üì•</button>
<input type="file" id="fileImport" style="display:none" onchange="leggiBackup(event)">
<h3>Crea Evento</h3>
<input id="nomeEvento" placeholder="Nome Evento">
<select id="tipoEvento">
<option value="maglia">Abbigliamento</option>
<option value="oggetto">Gadget</option>
</select>
<input type="number" id="prezzoEvento" placeholder="Prezzo ‚Ç¨">
<button class="primary" onclick="creaEvento()">Crea</button>
</div>
<div class="card">
${Object.keys(eventi).map(n=>`
<div class="row">
<button onclick="apriEvento('${n}')">${n}</button>
<button class="red" onclick="eliminaEvento('${n}')">X</button>
</div>`).join("")}
</div>`;
}

function creaEvento(){
let nome=nomeEvento.value;
let tipo=tipoEvento.value;
let prezzo=parseFloat(prezzoEvento.value);
if(!nome||!prezzo)return;
eventi[nome]={tipo,prezzo,ordini:[]};
salva();
renderHome();
}

function eliminaEvento(n){
if(confirm("Eliminare evento?")){
delete eventi[n];
salva();
renderHome();
}
}

function apriEvento(n){
eventoCorrente=n;
renderEvento();
}

/* ================= EVENTO ================= */

function renderEvento(){
let ev=eventi[eventoCorrente];

app.innerHTML=`
<div class="card">
<button onclick="renderHome()">‚Üê</button>
<h3>${eventoCorrente}</h3>
<p>Prezzo ‚Ç¨ ${ev.prezzo}</p>
</div>

<div class="card" id="formCard">
<input id="cliente" placeholder="Nome Cliente">
${ev.tipo==="maglia"
? taglie.map(t=>`
<div class="row">
<div>${t}</div>
<select id="q_${t}">
<option value="0">0</option>
${[1,2,3,4,5,6,7,8,9].map(n=>`<option>${n}</option>`).join("")}
</select>
</div>`).join("")
: `<select id="q_obj">
<option value="0">Quantit√†</option>
${[1,2,3,4,5,6,7,8,9].map(n=>`<option>${n}</option>`).join("")}
</select>`
}
<button class="primary" id="btnSubmit" onclick="aggiungiOrdine()">Aggiungi</button>
<button id="btnCancel" style="display:none;" onclick="annullaModifica()">Annulla modifica</button>
</div>

<div class="card"><h3>Ordini</h3><div id="listaOrdini"></div></div>
<div class="card"><h3>Statistiche</h3><div id="stats"></div></div>
<div class="card"><h3>üìã Riepilogo Ordini</h3><div id="riepilogo"></div></div>
<button onclick="window.print()">üñ® Stampa</button>
`;

aggiornaEvento();
}

function aggiungiOrdine(){
let ev=eventi[eventoCorrente];
let nome=cliente.value;
if(!nome)return;

let dettagli={},totale=0;

if(ev.tipo==="maglia"){
taglie.forEach(t=>{
let q=parseInt(document.getElementById("q_"+t).value);
if(q>0){dettagli[t]=q;totale+=q*ev.prezzo;}
});
}else{
let q=parseInt(q_obj.value);
if(q>0){dettagli["pezzi"]=q;totale+=q*ev.prezzo;}
}

if(indiceModifica!==null){
ev.ordini[indiceModifica]={nome,dettagli,totale,pagato:ev.ordini[indiceModifica].pagato};
indiceModifica=null;
}else{
ev.ordini.push({nome,dettagli,totale,pagato:false});
}

salva();
resetForm();
aggiornaEvento();
}

function resetForm(){
cliente.value="";
taglie.forEach(t=>{let el=document.getElementById("q_"+t);if(el)el.value=0;});
if(document.getElementById("q_obj"))q_obj.value=0;
btnSubmit.innerText="Aggiungi";
btnCancel.style.display="none";
}

function modificaOrdine(i){
indiceModifica=i;
let o=eventi[eventoCorrente].ordini[i];
cliente.value=o.nome;
taglie.forEach(t=>{let el=document.getElementById("q_"+t);if(el)el.value=o.dettagli[t]||0;});
if(document.getElementById("q_obj"))q_obj.value=o.dettagli["pezzi"]||0;
btnSubmit.innerText="Salva Modifica";
btnCancel.style.display="inline-block";
document.querySelectorAll(".row").forEach(r=>r.classList.remove("editing"));
document.querySelectorAll(".row")[i].classList.add("editing");
window.scrollTo({top:0,behavior:'smooth'});
}

function annullaModifica(){
indiceModifica=null;
resetForm();
document.querySelectorAll(".row").forEach(r=>r.classList.remove("editing"));
}

function eliminaOrdine(i){
if(confirm("Eliminare ordine?")){
eventi[eventoCorrente].ordini.splice(i,1);
salva();
aggiornaEvento();
}
}

function togglePagato(i){
eventi[eventoCorrente].ordini[i].pagato=!eventi[eventoCorrente].ordini[i].pagato;
salva();
aggiornaEvento();
}

function aggiornaEvento(){
let ev=eventi[eventoCorrente];
let lista=document.getElementById("listaOrdini");
let riepilogo=document.getElementById("riepilogo");
let stats=document.getElementById("stats");

lista.innerHTML="";
riepilogo.innerHTML="";

let inc=0,nonInc=0;

ev.ordini.forEach((o,i)=>{
if(o.pagato)inc+=o.totale;else nonInc+=o.totale;
let dettagli=Object.entries(o.dettagli).map(([k,v])=>v+" "+k).join(" ");

lista.innerHTML+=`
<div class="row">
<div>
<strong>${o.nome}</strong><br>
${dettagli}
</div>
<div style="text-align:right;">
‚Ç¨ ${o.totale}<br>
${o.pagato?"PAGATO":"NON PAGATO"}
</div>
<div>
<button onclick="modificaOrdine(${i})">‚úèÔ∏è</button>
<button class="red" onclick="eliminaOrdine(${i})">üóë</button>
<label class="switch">
<input type="checkbox" ${o.pagato?'checked':''} onchange="togglePagato(${i})">
<span class="slider"></span>
</label>
</div>
</div>`;
});

stats.innerHTML=`
<div class="stat-box">Incassato ‚Ç¨ ${inc}</div>
<div class="stat-box">Da incassare ‚Ç¨ ${nonInc}</div>
<div class="stat-box">Totale ordini ${ev.ordini.length}</div>
`;

let ordinati=[...ev.ordini].sort((a,b)=>a.nome.localeCompare(b.nome));
ordinati.forEach(o=>{
let dettagli=Object.entries(o.dettagli).map(([k,v])=>v+" "+k).join(" ");
riepilogo.innerHTML+=`
<div class="summary-box">
<strong>${o.nome}</strong><br>
${dettagli} ‚Äî ‚Ç¨ ${o.totale} (${o.pagato?"PAGATO":"NON PAGATO"})
</div>`;
});
}

/* BACKUP */

function esportaBackup(){
let blob=new Blob([JSON.stringify({eventi,pin:savedPIN})],{type:"application/json"});
let url=URL.createObjectURL(blob);
let a=document.createElement("a");
a.href=url;
a.download="giorders_backup.json";
a.click();
}

function importaBackup(){fileImport.click();}
function leggiBackup(e){
let reader=new FileReader();
reader.onload=function(ev){
let d=JSON.parse(ev.target.result);
eventi=d.eventi||{};
savedPIN=d.pin||"1926";
salva();
renderHome();
};
reader.readAsText(e.target.files[0]);
}

function toggleDark(){document.body.classList.toggle("dark");}

if('serviceWorker'in navigator){navigator.serviceWorker.register('sw.js');}

renderLogin();
</script>
</body>
</html>
