<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>GiOrders Pro</title>

<link rel="manifest" href="manifest.json">

<style>

/* ===== BASE ===== */

body{
    margin:0;
    font-family:-apple-system,BlinkMacSystemFont;
    background:#f2f2f7;
}

.dark{
    background:#111;
    color:white;
}

.card{
    background:white;
    margin:20px;
    padding:24px;
    border-radius:18px;
    box-shadow:0 5px 20px rgba(0,0,0,0.08);
}

.dark .card{
    background:#1c1c1e;
}

h1,h2{
    text-align:center;
    margin-bottom:20px;
}

input,select{
    width:100%;
    padding:14px;
    border-radius:12px;
    border:1px solid #ddd;
    margin-bottom:14px;
    font-size:16px;
}

button{
    padding:12px 18px;
    border:none;
    border-radius:12px;
    font-size:15px;
    cursor:pointer;
}

.primary{
    background:#007aff;
    color:white;
}

.gray{
    background:#d1d1d6;
}

.danger{
    background:#ff3b30;
    color:white;
}

/* ===== HOME ARIOSA ===== */

.btn-grid{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:12px;
}

.event-row{
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:14px 0;
    border-bottom:1px solid #eee;
}

.event-actions{
    display:flex;
    gap:10px;
}

/* ===== SWITCH PAGAMENTO ===== */

.paid-container{
    display:flex;
    align-items:center;
    justify-content:center;
    gap:14px;
    margin:20px 0;
    font-weight:600;
    font-size:14px;
}

.paid-label{
    opacity:0.5;
    transition:0.3s;
}

.paid-label.left{ color:#ff3b30; }
.paid-label.right{ color:#34c759; }

.switch{
    position:relative;
    display:inline-block;
    width:50px;
    height:28px;
}

.switch input{
    opacity:0;
    width:0;
    height:0;
}

.slider{
    position:absolute;
    cursor:pointer;
    top:0; left:0; right:0; bottom:0;
    background:#ccc;
    transition:.4s;
    border-radius:34px;
}

.slider:before{
    position:absolute;
    content:"";
    height:22px;
    width:22px;
    left:3px;
    bottom:3px;
    background:white;
    transition:.4s;
    border-radius:50%;
}

input:checked + .slider{
    background:#34c759;
}

input:checked + .slider:before{
    transform:translateX(22px);
}

/* ===== PIN APP STYLE ===== */

.pinScreen{
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    height:100vh;
}

.pinDisplay{
    font-size:34px;
    letter-spacing:10px;
    margin-bottom:30px;
}

.keypad{
    display:grid;
    grid-template-columns:repeat(3,80px);
    gap:16px;
}

.keypad button{
    font-size:20px;
    padding:18px;
    border-radius:50%;
    background:#e5e5ea;
}

.hidden{ display:none }

@media print{
    button{ display:none }
}

</style>
</head>

<body>

<div id="pinScreen" class="pinScreen"></div>
<div id="app" class="hidden"></div>

<script>
/* ===== DATI ===== */

let data = JSON.parse(localStorage.getItem("giordersPro")) || {
    settings:{
        pin:"1926",
        dark:false
    },
    events:[]
};

let currentEvent = null;
let tempPin = "";

/* ===== SALVATAGGIO ===== */

function saveData(){
    localStorage.setItem("giordersPro", JSON.stringify(data));
}

/* ===== PIN SCREEN ===== */

function renderPin(){
    document.getElementById("pinScreen").innerHTML = `
        <h2>Inserisci PIN</h2>
        <div class="pinDisplay">${tempPin.replace(/./g,"‚Ä¢")}</div>
        <div class="keypad">
            ${[1,2,3,4,5,6,7,8,9].map(n=>`<button onclick="pressPin(${n})">${n}</button>`).join("")}
            <button onclick="clearPin()">C</button>
            <button onclick="pressPin(0)">0</button>
            <button onclick="checkPin()">OK</button>
        </div>
    `;
}

function pressPin(n){
    if(tempPin.length<4){
        tempPin+=n;
        renderPin();
    }
}

function clearPin(){
    tempPin="";
    renderPin();
}

function checkPin(){
    if(tempPin===data.settings.pin){
        document.getElementById("pinScreen").classList.add("hidden");
        document.getElementById("app").classList.remove("hidden");
        renderHome();
    }else{
        alert("PIN errato");
        clearPin();
    }
}

/* ===== HOME ===== */

function renderHome(){
    document.getElementById("app").innerHTML = `
    <div class="card">
        <h2>Nuovo Evento</h2>

        <input id="evName" placeholder="Nome evento">

        <select id="evType">
            <option value="Abbigliamento">Abbigliamento</option>
            <option value="Gadget">Gadget</option>
            <option value="Bus">Bus</option>
        </select>

        <input id="evPrice" type="number" placeholder="Prezzo ‚Ç¨">
        <input id="evSeats" type="number" placeholder="Posti Bus (solo Bus)">

        <div class="btn-grid">
            <button class="primary" onclick="createEvent()">Crea Evento</button>
            <button class="gray" onclick="toggleDark()">üåô Modalit√†</button>
            <button class="gray" onclick="changePin()">üîê Cambia PIN</button>
            <button class="gray" onclick="exportBackup()">üíæ Backup</button>
        </div>

        <input type="file" onchange="importBackup(event)">
    </div>

    <div class="card">
        <h2>Eventi</h2>
        ${renderEventList()}
    </div>
    `;
}

/* ===== EVENTI ===== */

function createEvent(){
    let name=document.getElementById("evName").value;
    let type=document.getElementById("evType").value;
    let price=parseFloat(document.getElementById("evPrice").value)||0;
    let seats=parseInt(document.getElementById("evSeats").value)||0;

    if(!name) return alert("Inserisci nome evento");

    data.events.push({
        name,
        type,
        price,
        seats,
        orders:[]
    });

    saveData();
    renderHome();
}

function renderEventList(){
    if(data.events.length===0) return "Nessun evento";

    return data.events.map((ev,i)=>`
        <div class="event-row">
            <div>
                <strong>${ev.name}</strong><br>
                <small>${ev.type}</small>
            </div>
            <div class="event-actions">
                <button class="primary" onclick="openEvent(${i})">Apri</button>
                <button class="danger" onclick="deleteEvent(${i})">Elimina</button>
            </div>
        </div>
    `).join("");
}

function openEvent(i){
    currentEvent=i;
    renderEvent();
}

function deleteEvent(i){
    if(confirm("Eliminare evento?")){
        data.events.splice(i,1);
        saveData();
        renderHome();
    }
}

/* ===== DARK MODE ===== */

function toggleDark(){
    data.settings.dark=!data.settings.dark;
    document.body.classList.toggle("dark");
    saveData();
}

/* ===== CAMBIO PIN ===== */

function changePin(){
    let newPin=prompt("Nuovo PIN 4 cifre");
    if(newPin && newPin.length===4){
        data.settings.pin=newPin;
        saveData();
        alert("PIN aggiornato");
    }
}
/* ===== PAGINA EVENTO ===== */

function renderEvent(){
    let ev = data.events[currentEvent];

    document.getElementById("app").innerHTML = `
    <div class="card">
        <h2 style="text-align:center">${ev.name} - ‚Ç¨${ev.price}</h2>

        <input id="clientName" placeholder="Nome">

        ${ev.type==="Abbigliamento" ? renderSizes() : `
            <input id="quantity" type="number" placeholder="Quantit√†">
        `}

        <div class="paid-container">
            <span class="paid-label left">NON PAGATO</span>

            <label class="switch">
                <input type="checkbox" id="paidSwitch">
                <span class="slider"></span>
            </label>

            <span class="paid-label right">PAGATO</span>
        </div>

        <div style="display:flex;gap:10px;margin-top:15px">
            <button class="primary" style="flex:1" onclick="saveOrder()">Salva</button>
            <button class="gray" onclick="renderHome()">Indietro</button>
        </div>
    </div>

    <div class="card">
        <h2>Ordini</h2>
        ${renderOrders()}
    </div>

    <div class="card">
        <h2>Emissione Ordine</h2>
        ${renderEmission()}
    </div>
    `;
}

/* ===== TAGLIE ===== */

function renderSizes(){
    const sizes=["XS","S","M","L","XL","XXL","XXXL"];

    return sizes.map(s=>`
        <div style="display:flex;justify-content:space-between;align-items:center;margin:8px 0">
            <span>${s}</span>
            <select id="size_${s}" style="width:70px">
                ${Array.from({length:21},(_,i)=>`<option value="${i}">${i}</option>`).join("")}
            </select>
        </div>
    `).join("");
}

/* ===== SALVA ORDINE ===== */

function saveOrder(){
    let ev = data.events[currentEvent];
    let name = document.getElementById("clientName").value;
    let paid = document.getElementById("paidSwitch").checked;

    if(!name) return alert("Inserisci nome");

    let order = {
        name,
        paid,
        items:{}
    };

    if(ev.type==="Abbigliamento"){
        ["XS","S","M","L","XL","XXL","XXXL"].forEach(s=>{
            let qty=parseInt(document.getElementById("size_"+s).value)||0;
            if(qty>0) order.items[s]=qty;
        });
    }else{
        let q=parseInt(document.getElementById("quantity").value)||0;
        if(q>0) order.items["Q"]=q;
    }

    ev.orders.push(order);
    saveData();
    renderEvent();
}

/* ===== RENDER ORDINI ===== */

function renderOrders(){
    let ev=data.events[currentEvent];
    if(ev.orders.length===0) return "Nessun ordine";

    return ev.orders.map((o,i)=>`
        <div style="margin-bottom:15px;border-bottom:1px solid #ddd;padding-bottom:10px">
            <strong>${o.name}</strong><br>
            ${renderOrderItems(o)}
            ‚Ç¨ ${calculateTotal(o)} - 
            <span style="color:${o.paid?"#2ecc71":"#ff3b30"}">
                ${o.paid?"PAGATO":"NON PAGATO"}
            </span>
            <div style="margin-top:8px">
                <button class="gray" onclick="togglePaid(${i})">Toggle</button>
                <button class="danger" onclick="deleteOrder(${i})">Elimina</button>
            </div>
        </div>
    `).join("");
}

function renderOrderItems(order){
    return Object.keys(order.items).map(k=>`${order.items[k]} ${k}`).join(" - ");
}

function calculateTotal(order){
    let ev=data.events[currentEvent];
    let total=0;
    Object.values(order.items).forEach(q=>{
        total+=q*ev.price;
    });
    return total;
}

function togglePaid(i){
    let ev=data.events[currentEvent];
    ev.orders[i].paid=!ev.orders[i].paid;
    saveData();
    renderEvent();
}

function deleteOrder(i){
    let ev=data.events[currentEvent];
    ev.orders.splice(i,1);
    saveData();
    renderEvent();
}

/* ===== EMISSIONE ORDINE ===== */

function renderEmission(){
    let ev=data.events[currentEvent];
    let totals={};

    ev.orders.forEach(o=>{
        Object.keys(o.items).forEach(k=>{
            totals[k]=(totals[k]||0)+o.items[k];
        });
    });

    if(Object.keys(totals).length===0) return "Nessun dato";

    return Object.keys(totals).map(k=>`
        <div>${k}: ${totals[k]} pezzi</div>
    `).join("");
}
/* ===== BACKUP / RIPRISTINO ===== */

function exportBackup(){
    const blob = new Blob([JSON.stringify(data)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "giorders_backup.json";
    a.click();
}

document.getElementById("importFile").addEventListener("change",function(e){
    const file = e.target.files[0];
    if(!file) return;

    const reader = new FileReader();
    reader.onload = function(evt){
        data = JSON.parse(evt.target.result);
        saveData();
        renderHome();
        alert("Backup ripristinato");
    };
    reader.readAsText(file);
});

/* ===== CAMBIO PIN ===== */

function changePin(){
    let newPin = prompt("Nuovo PIN:");
    if(newPin && newPin.length>=4){
        data.settings.pin=newPin;
        saveData();
        alert("PIN aggiornato");
    }
}

/* ===== AVVIO APP ===== */

if(data.settings.dark){
    document.body.classList.add("dark");
}

renderPin();
</script>
</body>
</html>